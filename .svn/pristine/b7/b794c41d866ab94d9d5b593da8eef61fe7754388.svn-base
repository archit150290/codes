<?php get_header(); ?>
<!-- start content -->
<div class='wrap'><!--Closing div is in footer.php-->
    <!-- start landing marquee -->
    <div class='landing-marquee_video dharmatalks'>
        <header class='rubric_top'>
            <h1><span class='icon icon-dept_dharmatalks'></span>Dharma Talks</h1>
            <p>Video teachings and discussions with contemporary Buddhist teachers</p>
            <a class='button' href='<?php echo get_permalink(get_page_id_by_slug(DHARMA_TALKS_ARCHIVE_PAGE_SLUG)); ?>'>Dharma Talks Archive</a>
        </header>

        <main>
            <?php
            $postId = array();
            if (have_posts()) {
                while (have_posts()) {
                    the_post();
                    $postId[] = get_the_ID();
                    $topics = get_topics_by_post_id(get_the_ID());
                    $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                    ?>
                    <article class='dharmatalks'>
                        <section class='titles'>
                            <time><?php the_date('M Y'); ?></time>
                            <h2 class='dharmatalks'><span class='topic'><?php echo $topic_urls; ?></span></h2>
                            <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                            <address><?php echo getAuthorDetail(get_the_ID(), 0, 0); ?></address>
                        </section>
                        <figure>
                            <a href='<?php the_permalink(); ?>'>
                                <div class='icon-video_play' data-grunticon-embed></div>
                                <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 60em) 75vw, 100vw'); ?>	
                            </a>
                        </figure>
                        <section class='synopsis'>
                            <p><?php the_excerpt(); ?></p>
                            <p class='h2'><a class='view-contents' href='<?php the_permalink(); ?>'>Watch Talk</a></p>
                        </section>
                    </article>
                    <?php
                    break;
                }
            }
            ?>
        </main>
    </div>
    <!-- end landing marquee -->

    <!-- start landing stack -->
    <div class='landing-stack_video'>
        <?php
        if (have_posts()) {
            $counter = 1;
            while (have_posts()) {
                the_post();
                $postId[] = get_the_ID();
                $topics = get_topics_by_post_id(get_the_ID());
                $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                ?>
                <article class='dharmatalks'>
                    <section class='titles'>
                        <time><?php echo get_the_date('M Y'); ?></time>
                        <h2 class='dharmatalks'><span class='topic'><?php echo $topic_urls; ?></span></h2>
                        <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                        <address><?php echo getAuthorDetail(get_the_ID(), 0, 0); ?></address>
                    </section>
                    <figure>
                        <a href='<?php the_permalink(); ?>'>
                            <div class='icon-video_play' data-grunticon-embed></div>
                            <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 50em) 25vw,100vw'); ?>
                        </a>
                    </figure>
                    <section class='synopsis'>
                        <p><?php the_excerpt(); ?></p>
                        <p class='h2'><a class='view-contents' href='<?php the_permalink(); ?>'>Watch Talk</a></p>
                    </section>
                </article>
                <?php
                if($counter == 2 || $counter == 6)
                {
                    ?>
                    <div class='CTA-module'>
                        <div class='rule'></div>
                        <div class='CTA-ad' style='
                             background-color: #ddd;
                             line-height: 1; padding: 2em;
                             margin: 0 auto;
                             width: 75%;
                             height: 10em;
                             text-align: center;
                             '>
                            <p>Call-to-Action Module. Can be set in the CMS to any of the following: (1) Ad served via Google DFP Small Business (TBD), (2) Daily Dharma, (3) Subscribe CTA, (4) Newletter CTA</p>
                        </div>
                        <div class='rule'></div>
                    </div>
                    <?php
                }
                $counter++;
                
                if($counter == 6)
                {
                    break;
                }
            }
        }
        ?>        
        <div class='more dharmatalks'>
            <a class='button' href='<?php echo get_permalink(get_page_id_by_slug(DHARMA_TALKS_ARCHIVE_PAGE_SLUG)); ?>'>Dharma Talks Archive</a>
        </div>        
    </div>
    <div class='rule'></div>
    <!-- end landing stack -->

    <!-- start most popular module -->
    <?php
    $mostpopularpost = getMostViewPosts(DHARMATALKS_POST_TYPE, $postId, 3);
    if (!empty($mostpopularpost)) {
        ?>
        <div class='related-posts'>
            <header class='rubric_top'>
                <h1>Most Popular</h1>
            </header>

            <main>
                <?php
                foreach ($mostpopularpost as $mostpopular) {
                    $topics = get_topics_by_post_id($mostpopular['postId']);
                    $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                    ?>
                    <article class='dharmatalks'>
                        <figure>
                            <a href='<?php echo $mostpopular['permalink']; ?>'>
                                <div class='icon-video_play' data-grunticon-embed></div>
                                <?php echo srcset_post_thumbnail($mostpopular['postId'], 'image', '', '(min-width: 50em) 33vw,100vw'); ?>
                            </a>
                        </figure>
                        <section>
                            <h2 class='rubric dharmatalks'><span class='topic'><?php echo $topic_urls; ?></span></h2>
                            <h1><a href='<?php echo $mostpopular['permalink']; ?>'><?php echo $mostpopular['title']; ?></a></h1>
                            <address><?php echo getAuthorDetail($mostpopular['postId'], 0, 0); ?></address>
                            <time><?php echo $mostpopular['publish_date']; ?></time>
                        </section>
                    </article>
                    <?php 
                }
                ?>
            </main>
        </div>
        <?php 
    } 
    ?>
    <!-- start Call to Action module -->
    <div class='CTA-module'>
        <div class='rule'></div>
        <div class='CTA-ad' style='
             background-color: #ddd;
             line-height: 1; padding: 2em;
             margin: 0 auto;
             width: 75%;
             height: 10em;
             text-align: center;
             '>
            <p>Call-to-Action Module. Can be set in the CMS to any of the following: (1) Ad served via Google DFP Small Business (TBD), (2) Daily Dharma, (3) Subscribe CTA, (4) Newletter CTA</p>
        </div>
        <div class='rule'></div>
    </div>
    <!-- end Call to Action module -->

    <div class='aside-depts'>
        <!-- start aside Film Club -->
        <section class='aside-filmclub'>
            <header class='rubric_small'>
                <h1><a href='<?php echo get_post_type_archive_link(FILM_CLUB_POST_TYPE); ?>'><span class='icon icon-dept_filmclub'></span>Film Club</a></h1>
                <p>Buddhist films and discussion for the Tricycle Community</p>
            </header>
            <main>
                <?php
                $args = array(
                    'posts_per_page' => 1,
                    'orderby' => 'post_date',
                    'order' => 'DESC',
                    'post_type' => FILM_CLUB_POST_TYPE,
                    'post_status' => 'publish',
                    'suppress_filters' => true
                );

                $querydharma = new WP_Query($args);
                while ($querydharma->have_posts()) : $querydharma->the_post();
                    $topics = get_topics_by_post_id($post->ID);
                    $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                    ?>
                    <article>
                        <figure>
                            <a href='<?php the_permalink(); ?>'>
                                <div class='icon-video_play' data-grunticon-embed></div>
                                <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 50em) 33vw,100vw'); ?>
                            </a>
                        </figure>
                        <section>
                            <h2 class='rubric filmclub'><span class='topic'><?php echo $topic_urls; ?></span></h2>
                            <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                            <p><?php the_excerpt(); ?></p>
                            <address><?php echo getAuthorDetail(get_the_ID(), 1, 0); ?></address>
                        </section>
                    </article>
                    <?php
                endwhile;
                wp_reset_query();
                ?>
            </main>
        </section>
        <!-- end aside Film Club -->

        <!-- start aside magazine -->
        <section class='aside-magazine'>
            <header class='rubric_small'>
                <h1><a href='<?php echo get_post_type_archive_link(MAGAZINE_POST_TYPE); ?>'><span class='icon icon-dept_magazine'></span>Magazine</a></h1>
                <p>The Buddhist Review</p>
            </header>
            <main>
                <?php
                $args = array(
                    'posts_per_page' => 1,
                    'orderby' => 'post_date',
                    'order' => 'DESC',
                    'post_type' => MAGAZINE_POST_TYPE,
                    'post_status' => 'publish',
                    'suppress_filters' => true
                );
                $querymagazine = new WP_Query($args);

                while ($querymagazine->have_posts()) : $querymagazine->the_post();
                    $topics = get_topics_by_post_id($post->ID);
                    $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";

                    $issues = get_issues_by_post_id($post->ID);
                    $issues_names_without_urls = $issues && isset($issues['names_without_urls']) ? implode(", ", $issues['names_without_urls']) : "";
                    ?>
                    <article>
                        <figure>
                            <a href='<?php the_permalink(); ?> '>
                                <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 50em) 33vw,100vw'); ?>
                            </a>
                        </figure>
                        <section>
                            <h2 class='rubric magazine'><span class='topic'><?php echo $topic_urls; ?></span></h2>
                            <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                            <p><?php the_excerpt(); ?></p>
                            <address><?php echo getAuthorDetail(get_the_ID(), 1, 0); ?></address>
                            <time><?php echo $issues_names_without_urls; ?></time>
                        </section>
                    </article>
                    <?php
                endwhile;
                wp_reset_query();
                ?>
            </main>
            <div class='rule-responsive'></div>
        </section>
        <!-- end aside magazine -->

        <!-- start aside trikedaily -->
        <section class='aside-trikedaily'>
            <header class='rubric_small'>
                <h1><a href='<?php echo get_permalink(get_page_id_by_slug(TRIKE_DAILY_SLUG)); ?>'><span class='icon icon-dept_trikedaily'></span>Trike Daily</a></h1>
                <p>Daily wisdom, teachings &amp; critique</p>
            </header>

            <main>
                <?php
                $args = array(
                    'posts_per_page' => 1,
                    'orderby' => 'post_date',
                    'order' => 'DESC',
                    'post_status' => 'publish',
                    'suppress_filters' => true
                );

                $querymagazine = new WP_Query($args);
                while ($querymagazine->have_posts()) : $querymagazine->the_post();
                    $topics = get_topics_by_post_id($post->ID);
                    $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                    ?>
                    <article>
                        <figure>
                            <a href='<?php the_permalink(); ?>'>										
                                <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 50em) 33vw,100vw'); ?>
                            </a>
                        </figure>
                        <section>
                            <h2 class='rubric trikedaily'><span class='topic'><?php echo $topic_urls; ?></span></h2>
                            <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                            <p><?php the_excerpt() ?></p>
                            <address><?php echo getAuthorDetail(get_the_ID(), 1, 0); ?></address>
                            <time><?php the_date('M d, Y'); ?></time>
                        </section>
                    </article>
                    <?php
                endwhile;
                wp_reset_query();
                ?>
            </main>
            <div class='rule-responsive'></div>
        </section>
        <!-- end aside trikedaily -->
    </div>

    <div class='rule'></div>
    <!-- end wrap_outer -->
    <?php get_footer(); ?>
