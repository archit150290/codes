<?php
/*
  Template Name: dharmatalks archive
 */
//pr($_REQUEST);
?>
<?php get_header(); ?>

<?php
$post = get_post();
$pageslug = $post->post_name;
$pageUrl = get_site_url() . "/" . $pageslug . "/";
?>
<script>
    var pageurl = '<?php echo $pageUrl; ?>';
</script>
<!-- start content -->
<div class='wrap'>

    <!-- start magazine rubric -->
    <div class='rubric_top'>
        <h1><span class='icon icon-dept_dharmatalks'></span>Dharma Talks</h1>
        <p>Video teachings and discussions with contemporary Buddhist teachers</p>
    </div>
    <!-- end magazine rubric -->

    <!-- start archive_ebooks grid -->
    <div class='archive_dharmatalks'>
        <div class='rule'></div>

        <header class='rubric_mid dharmatalks'>
            <h1>Archive</h1>
            <?php
            $currentYear = date('Y');
            $getSearchArr = explode($pageslug, str_replace("/", "", $_SERVER['REQUEST_URI']));
            $searchYear = isset($getSearchArr[1]) ? $getSearchArr[1] : $currentYear;
            ?>
            <div class='dropdown'>
                <div class='dropdown-container'>
                    <p class='button dropdown-button'>Browse By Year</p>
                    <ul class='dropdown-menu dropdown-select'>
                        <?php
                        for ($i = $currentYear; $i >= 1991; $i--) {
                            ?>
                            <li class="yeardropdown" rel="<?php echo $i; ?>"><a href='javascript:void(0);'><?php echo $i; ?></a></li>
                            <?php
                        }
                        ?>
                    </ul>
                </div>
            </div>

        </header>

        <main id="moredata">
            <?php
            /* Get Post counts */
            $posts = get_posts(array(
                'numberposts' => -1, 'post_status' => 'publish', 'post_type' => FILM_CLUB_POST_TYPE, 'year' => $searchYear,
            ));
            $publishPosts = count($posts);
            /* Get Post counts Ends */

            $args = array(
                'posts_per_page' => 12,
                'orderby' => 'post_date',
                'order' => 'DESC',
                'year' => $searchYear,
                'post_type' => DHARMATALKS_POST_TYPE,
                'post_status' => 'publish',
                'suppress_filters' => true
            );

            $queryfirst = new WP_Query($args);
            query_posts($queryfirst);
            $i = 1;
            while ($queryfirst->have_posts()) : $queryfirst->the_post();
                $postId[] = $queryfirst->post->ID;

                $topics = get_topics_by_post_id(get_the_ID());
                $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";

                $publish_date = get_the_date('M Y');
                ?>
                <div class='archive-item'>
                    <figure class='archive-cover_dharmatalks'>
                        <a href='<?php the_permalink(); ?>'>
                            <div class='icon-video_play' data-grunticon-embed></div>
                            <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 60em) 33vw,(min-width: 37.5em) 50vw,100vw'); ?>
                        </a>
                    </figure>
                    <header class='archive-titles'>
                        <time><?php echo $publish_date; ?></time>
                        <h2 class='topic dharmatalks'><?php echo $topic_urls; ?></h2>
                        <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                        <address><?php echo getAuthorDetail(get_the_ID(),0,0); ?></address>
                    </header>
                </div>
                <?php
                if ($i == 12) {
                    break;
                }
            endwhile;
            wp_reset_query();
            ?>
        </main>
        <?php
        if ($publishPosts > 12) {
            $post_type = DHARMATALKS_POST_TYPE;
            ?>
            <div class='more dharmatalks'>
                  <div id="abc"></div>
                    <input type="hidden" name="postId" id="postId" value="<?php echo json_encode($postId); ?>" />
                    <input type="hidden" name="posttype" id="posttype" value="<?php echo DHARMATALKS_POST_TYPE; ?>" />
                    <input type="hidden" name="searchyear" id="searchyear" value="<?php echo $searchYear; ?>" />
                    <!-- tax name, post type, url, post id's -->
                    <a href='javascript:void(0)' id="archiveloadmore" onclick="loadmorearchive()">Load More</a>
                </div>
        <?php } ?>
    </div>
    <!-- end archive_magazine grid -->
    <div class='rule'></div>

    <!-- start most popular module -->
    <?php
    if (!empty($postId)) {
        $postId = $postId;
    } else {
        $postId = "";
    }
    $mostpopularpost = getMostViewPosts(DHARMATALKS_POST_TYPE, $postId, 3);
    if (!empty($mostpopularpost)) {
        ?>
        <div class='related-posts'>
            <header class='rubric_top'>
                <h1>Most Popular</h1>
            </header>

            <main>
                <?php
                foreach ($mostpopularpost as $mostpopular) {
                    
                    $topics = get_topics_by_post_id($mostpopular['postId']);
                    $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                    
                    ?>
                    <article class='dharmatalks'>
                        <figure>
                            <a href='<?php echo $mostpopular['permalink']; ?>'>
                                <div class='icon-video_play' data-grunticon-embed></div>
                                <?php echo srcset_post_thumbnail($mostpopular['postId'], 'image', '', '(min-width: 50em) 33vw,100vw'); ?>

                            </a>
                        </figure>
                        <section>
                            <h2 class='rubric dharmatalks'><span class='topic'><?php echo $topic_urls; ?></span></h2>
                            <h1><a href='<?php echo $mostpopular['permalink']; ?>'><?php echo $mostpopular['title']; ?></a></h1>
                            <address><?php echo getAuthorDetail($mostpopular['postId'],0,0); ?></address>
                            <time><?php echo $mostpopular['publish_date']; ?></time>
                        </section>
                    </article>
                <?php } ?>    

            </main>
        </div>
    <?php } ?>
    <!-- end most popular dharmatalks module -->

    <!-- start Call to Action module -->
    <div class='CTA-module'>
        <div class='rule'></div>
        <div class='CTA-ad' style='
             background-color: #ddd;
             line-height: 1; padding: 2em;
             margin: 0 auto;
             width: 75%;
             height: 10em;
             text-align: center;
             '>
            <p>Call-to-Action Module. Can be set in the CMS to any of the following: (1) Ad served via Google DFP Small Business (TBD), (2) Daily Dharma, (3) Subscribe CTA, (4) Newletter CTA</p>
        </div>
        <div class='rule'></div>
    </div>
    <!-- end Call to Action module -->

    <aside>
        <div class='aside-depts'>
            <!-- start aside Film Club -->
            <section class='aside-filmclub'>
                <header class='rubric_small'>
                    <h1><a href='<?php echo get_site_url().'/'.FILM_CLUB_POST_TYPE;  ?>'><span class='icon icon-dept_filmclub'></span>Film Club</a></h1>
                    <p>Buddhist films and discussion for the Tricycle Community</p>
                </header>

                <main>
                    <?php
                    $args = array(
                        'posts_per_page' => 1,
                        'orderby' => 'post_date',
                        'order' => 'DESC',
                        'post_type' => FILM_CLUB_POST_TYPE,
                        'post_status' => 'publish',
                        'suppress_filters' => true
                    );
                    $querymagazine = new WP_Query($args);
                    query_posts($querymagazine);
                    while ($querymagazine->have_posts()) : $querymagazine->the_post();

                        $topics = get_topics_by_post_id(get_the_ID());
                        $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";

                        $issueSet = get_the_terms(get_the_ID(), "magazine-issue");
                        $issueName = isset($issueSet[0]) ? $issueSet[0]->name : "";
                        $issueSlug = isset($issueSet[0]) ? $issueSet[0]->slug : "";
                        ?>
                    <article>
                        <figure>
                            <a href='<?php the_permalink(); ?>'>
                                <div class='icon-video_play' data-grunticon-embed></div>
                                <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '','(min-width: 50em) 33vw,100vw'); ?>
                            </a>
                        </figure>
                        <section>
                            <h2 class='rubric filmclub'><span class='topic'><?php echo  $topic_urls; ?></span></h2>
                            <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                            <p><?php the_excerpt(); ?></p>
                            <address><?php echo getAuthorDetail(get_the_ID(),1,0); ?></address>
                        </section>
                    </article>
                     <?php
                    endwhile;
                    wp_reset_query();
                    ?>
                </main>
            </section>
            <!-- end aside Film Club -->

            <!-- start aside magazine -->
            <section class='aside-magazine'>
                <header class='rubric_small'>
                    <h1><a href='<?php echo get_site_url().'/'.MAGAZINE_POST_TYPE;  ?>'><span class='icon icon-dept_magazine'></span>Magazine</a></h1>
                    <p>The Buddhist Review</p>
                </header>

                <main>
                    <?php
                    $args = array(
                        'posts_per_page' => 1,
                        'orderby' => 'post_date',
                        'order' => 'DESC',
                        'post_type' => MAGAZINE_POST_TYPE,
                        'post_status' => 'publish',
                        'suppress_filters' => true
                    );

                    $querymagazine = new WP_Query($args);
                    query_posts($querymagazine);
                    while ($querymagazine->have_posts()) : $querymagazine->the_post();

                        $topics = get_topics_by_post_id(get_the_ID());
                        $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";

                        $issueSet = get_the_terms(get_the_ID(), "magazine-issue");
                        $issueName = isset($issueSet[0]) ? $issueSet[0]->name : "";
                        $issueSlug = isset($issueSet[0]) ? $issueSet[0]->slug : "";
                        ?>
                        <article>
                            <figure>
                                <a href='<?php the_permalink(); ?>'>
                                        <!--<img src='images/jpg/home-magazine_1x.jpg'
                                                srcset='images/jpg/home-magazine_2x.jpg 1000w,
                                                        images/jpg/home-magazine_1x.jpg 500w'
                                                        sizes= '(min-width: 50em) 33vw,
                                                        100vw'
                                                alt='A man' />-->
                                    <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 50em) 33vw,100vw'); ?>
                                </a>
                            </figure>
                            <section>
                                <h2 class='rubric magazine'><span class='topic'><?php echo $topic_urls; ?></span></h2>
                                <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                                <p><?php the_excerpt(); ?></p>
                                <address><?php echo getAuthorDetail(get_the_ID(),1,0); ?></address>
                                <time><?php echo $issueName; ?></time>
                            </section>
                        </article>

                        <?php
                    endwhile;
                    wp_reset_query();
                    ?>
                </main>
            </section>
            <!-- end aside magazine -->

            <!-- start aside trikedaily -->
            <section class='aside-trikedaily'>
                <header class='rubric_small'>
                    <h1><a href='<?php echo get_site_url().'/blog';  ?>'><span class='icon icon-dept_trikedaily'></span>Trike Daily</a></h1>
                    <p>Daily wisdom, teachings &amp; critique</p>
                </header>

                <main>
                    <?php
                    $args = array(
                        'post_type' => 'post',
                        'post_status' => 'publish',
                        'order' => 'DESC',
                        'orderby' => 'date',
                        'posts_per_page' => 1,
                            //  'post__not_in' =>$postId,
                    );
                    $eq_query = new WP_Query($args);
                    while ($eq_query->have_posts()) : $eq_query->the_post();
                        $topics = get_topics_by_post_id(get_the_ID());
                        $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                        ?>
                        <article>
                            <figure>
                                <a href='<?php the_permalink(); ?>'>
                                    <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 37.5em) 25vw, 100vw'); ?>
                                </a>
                            </figure>
                            <section>
                                <h2 class='rubric trikedaily'><span class='topic'><?php echo $topic_urls; ?></span></h2>
                                <h1><a href='<?php the_permalink(); ?>'><?php echo get_the_title(); ?></a></h1>
                                <p><?php the_excerpt(); ?></p>
                                <address><?php echo getAuthorDetail(get_the_ID(),1,0); ?></address>
                                <time><?php echo get_the_date('M d, Y'); ?></time>
                            </section>
                        </article>

                        <?php
                    endwhile;
                    wp_reset_query();
                    ?>
                </main>
                <div class='rule-responsive'></div>
            </section>
            <!-- end aside trikedaily -->
        </div>

        <div class='rule'></div>

        

<?php get_footer(); ?>