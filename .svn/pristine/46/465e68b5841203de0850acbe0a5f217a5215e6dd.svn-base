<?php

//Connect to the database
include_once '../../../wp-config.php';
$action = $_POST['action'];
$updateRecordsArray = $_POST['recordsArray'];

if($action == "updateFilmFestival"){
    $listingcounter = 1;
    foreach($updateRecordsArray as $record_values){
        update_post_meta($record_values, "menu_order_filmfestival", $listingcounter);
        $listingcounter++;
    } 
    echo "Data Updated Successfully";
}
else if($action == "updateissues")
{
    $issues = $_POST['magazine-issue'];
    $department = $_POST['magazine-department'];
    global $wpdb;
    $listingCounter = 1;
    foreach($updateRecordsArray as $recordsIDarray)
    {
        $my_post = array('ID'=>$recordsIDarray, 'menu_order' => $listingCounter);
        //pr($my_post);
        wp_update_post($my_post);
        $listingCounter = $listingCounter + 1;
    }
    
    
    
    $args = array(
            'post_type' => array(MAGAZINE_POST_TYPE),
            'tax_query' => array(
                'relation' => 'AND',
                array(
                    'taxonomy' => MAGAZINE_POST_DEPARTMENT_TAXONOMY,
                    'field' => 'slug',
                    'terms' => array($department),
                    'operator' => 'IN',
                ),
                array(
                    'taxonomy' => 'magazine-issue',
                    'field' => 'slug',
                    'terms' => $issues,
                    'operator' => 'IN',
                ),
            ),
            'post_status' => 'publish',
            'order' => 'ASC',
            'orderby' => 'menu_order',
            'posts_per_page' => '-1'
    );
    
    $eq_query = new WP_Query($args);
    ?>
    
    <?php 
    if($eq_query->have_posts())
    {
        //pr($eq_query);
        while($eq_query->have_posts())
        {   global $post;
            $eq_query->the_post();
            ?>
            <tr id = "recordsArray_<?php echo $post->ID;?>">
                <td><a href="post.php?post=<?php echo $post->ID;?>&action=edit"><?php echo get_the_title();?></a></td>
            </tr>
        <?php 
        }
    }
}

else if ($action == "updateRecordsListings") {
    global $wpdb;
    $listingCounter = 1;
    foreach ($updateRecordsArray as $recordIDValue) {
        $my_post = array(
            'ID' => $recordIDValue,
            //'menu_order' => $listingCounter,
        );
        
        // $query = "UPDATE $wpdb->prefix"."posts SET menu_order = " . $listingCounter . " WHERE ID = " . $recordIDValue;
        //mysql_query($query) or die('Error.');
        $meta_key = "menu_order_marquee";
        update_post_meta($my_post['ID'], $meta_key, $listingCounter);
        $listingCounter = $listingCounter + 1;
    }
    $records = '';
    
    add_filter('pre_get_posts', 'change_order_marquee');
    function change_order_marquee($wp_query) {
        $wp_query->set('meta_key', 'menu_order_marquee');
        $wp_query->set('orderby', 'meta_value_num');
        $wp_query->set('order', 'ASC');
    }
    $args = array(
        'post_type' => array('post', MAGAZINE_POST_TYPE, DHARMATALKS_POST_TYPE, FILM_CLUB_POST_TYPE, EBOOKS_POST_TYPE, FILM_FESTIVAL_POST_TYPE),
        'post_status' => 'publish',
        'meta_query' => array(
            array(
                'key' => 'home_featured',
                'value' => '1',
                'compare' => 'IN',
            ),
        ),
       // 'order' => 'ASC',
        //'orderby' => 'menu_order',
         
    );
    $records = new WP_Query($args);
    if ($records and $records->have_posts()):
        $data = "";
        while ($records->have_posts()):
            $records->the_post();
            
            $post_type = get_post_type();
            $post_slug = "edit.php?post_type=".$post_type;
            if($post_type == "post")
            {
                $post_type = "Trike Daily";
                $post_slug = "edit.php?post_type=post";
            }
            $data .= '
                     <tr id="recordsArray_' . $records->post->ID . '">' .
                    '<td><a href="post.php?post=' . $post->ID . '&action=edit">' . get_the_title() . '</a></td>' .
                    '<td><a href="'.$post_slug.'">'.$post_type.'</a></td>'.
                    '<td>'. //$i .'</td>'.
                    '</tr>';
                
        endwhile;
        echo $data;
    else:
        echo "0";
    endif;
}


else if ($action == "updateCurrentIssues") {
    global $wpdb, $post;
    $listingCounter = 1;
    foreach ($updateRecordsArray as $recordIDValue) {
        $my_post = array(
            'ID' => $recordIDValue,
        );
        $meta_key = "menu_order";
        update_post_meta($my_post['ID'], $meta_key, $listingCounter);
        $listingCounter = $listingCounter + 1;
    }
    $records = '';

    $recentissue = get_magazine_issue_terms();
//pr($topicsfinal);
    echo $recentissueName = $recentissue[0]->name;

    function change_order($wp_query) {
        $wp_query->set('meta_key', 'menu_order');
        $wp_query->set('orderby', 'meta_value_num');
        $wp_query->set('order', 'ASC');
    }

    add_filter('pre_get_posts', 'change_order');

    $args = array(
        'post_type' => array(MAGAZINE_POST_TYPE),
        'post_status' => 'publish',
        'tax_query' => array(
            'relation' => 'AND',
            array(
                'taxonomy' => 'magazine-issue',
                'field' => 'slug',
                'terms' => array($recentissueName),
                'operator' => 'IN',
            ),
        ),
        'meta_query' => array(
            array(
                'key' => 'current_issue_meta_key',
                'value' => '1',
                'compare' => 'IN',
            ),
        ),
        'order' => 'ASC',
    );

    $eq_query = new WP_Query($args);
    if ($eq_query and $eq_query->have_posts()):
        $data = "";
        while ($eq_query->have_posts()):
            $eq_query->the_post();
            $eq_query->post->ID;
            $abcnew = get_post_meta($post->ID, 'menu_order', true);
            $data .= '
            <tr id="recordsArray_' . $post->ID . '">' .
            '<td><a href="post.php?post=' . $post->ID . '&action=edit">' . get_the_title() . '</a></td>' .
            '</tr>';
        endwhile;
        echo $data;
        else:
            echo "0";
        endif;
}

else {
    echo "0";
}
?>