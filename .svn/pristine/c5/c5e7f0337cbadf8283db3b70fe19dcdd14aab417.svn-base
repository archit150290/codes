<?php
/**
 * Template Name: Import Live Data
 */
?>

<?php
global $wpdb;

//DAILY-DHARMA IMPORT POSTS STARTS HERE.....  
/*$dailydharma = $wpdb->get_results("SELECT * FROM node WHERE type='daily_dharma' ORDER BY created ASC");
if($dailydharma)
{
    foreach($dailydharma as $dailydharmas)
    {
        $dailydharma_content = $wpdb->get_results("SELECT * FROM node_revisions WHERE nid = ".$dailydharmas->nid." ORDER BY timestamp DESC LIMIT 1");
        $dailydharma_node = $wpdb->get_results("SELECT * FROM nodehierarchy WHERE nid = ".$dailydharmas->nid."");
        $dailydharma_author = $wpdb->get_results("SELECT * FROM content_field_author WHERE nid = ".$dailydharma_node[0]->nid."");
        $authorName = $dailydharma_author[0]->field_author_value;
        
        $pub_date = date("Y-m-d H:i:s", $dailydharmas->created);
        $post_dharma = array(
            'post_title'    => wp_strip_all_tags($dailydharmas->title),
            'post_date'  => $pub_date,
            'post_content' => $dailydharma_content[0]->body,
            'post_excerpt' => "",
            'post_type' => "dailydharma",
            'post_status' => 'publish'
        );
        
        $postId = wp_insert_post($post_dharma);
        if($postId)
        {
            update_post_meta($postId, "dailydharma_authors_name_metabox", $authorName);                
        }
    }
}
//  DAILY-DHARMA IMPORT POSTS ENDS HERE.....  
die;   
*/

//FILMFESTIVAL IMPORT POSTS AND COMMENTS ENDS HERE.....  
/*
$filmfestival = $wpdb->get_results("SELECT * FROM node WHERE type='film_festival' ORDER BY created ASC");
if($filmfestival)
{
    foreach($filmfestival as $filmfestivals)
    {
        $filmfestival_content = $wpdb->get_results("SELECT * FROM node_revisions WHERE nid = ".$filmfestivals->nid." ORDER BY timestamp DESC LIMIT 1");
        $filmfestival_video = $wpdb->get_results("SELECT * FROM content_field_ff_field_video_embed WHERE nid = ".$filmfestivals->nid."");
        $filmfestival_trailer = $wpdb->get_results("SELECT * FROM content_field_ff_field_video_teaser WHERE nid = ".$filmfestivals->nid."");
        $filmfestival_trailer = $filmfestival_trailer[0]->field_ff_field_video_teaser_value;
        $filmfestival_video   = $filmfestival_video[0]->field_ff_field_video_embed_value;
        
        
        $pub_date = date("Y-m-d H:i:s", $filmfestivals->created);
        $post_content = array(
            'post_title'    => wp_strip_all_tags($filmfestivals->title),
            'post_date'  => $pub_date,
            'post_content' => $filmfestival_content[0]->body,
            'post_excerpt' => strip_tags($filmfestival_content[0]->teaser),
            'post_type' => "filmfestival",
            'post_status' => 'publish'
        );
        
        $postId = wp_insert_post($post_content);
        if($postId)
        {
            update_post_meta($postId, "meta_type_filmfest_video1", $filmfestival_video);
            update_post_meta($postId, "meta_type_filmfest_shorttrailer", $filmfestival_trailer);

            echo "<strong>Title: ".$filmfestivals->title."</strong><br/>";
            $comments = $wpdb->get_results("SELECT * FROM comments where nid = ".$filmfestivals->nid. " ORDER BY timestamp ASC");
            $existing_comment_ids = array();
            $new_comment_ids = array();
            foreach($comments as $comment)
            {
                if($comment->pid == 0)
                {
                    $commentdata = array(
                        'comment_post_ID' => $postId, 
                        'comment_author' => $comment->name, 
                        'comment_author_email' => $comment->mail, 
                        'comment_author_IP' => $comment->hostname,
                        'comment_content' => $comment->comment, 
                        'comment_parent' => 0, 
                        'user_id' => '', 
                        'comment_date' => date("Y-m-d H:i:s", $comment->timestamp),
                        'comment_approved' => 1,
                    );

                    $new_comment_id = wp_insert_comment($commentdata);
                    $existing_comment_ids[$comment->cid] = $new_comment_id;
                }                
            }

            foreach($comments as $comment)
            {
                if($comment->pid != 0)
                {
                    if(array_key_exists($comment->pid, $existing_comment_ids))
                    {
                        $parent_id = $existing_comment_ids[$comment->pid];
                        $commentdata = array(
                            'comment_post_ID' => $postId, 
                            'comment_author' => $comment->name, 
                            'comment_author_email' => $comment->mail, 
                            'comment_author_IP' => $comment->hostname,
                            'comment_content' => $comment->comment, 
                            'comment_parent' => $parent_id,
                            'user_id' => '', 
                            'comment_date' => date("Y-m-d H:i:s", $comment->timestamp),
                            'comment_approved' => 1,
                        );
                        $new_comment_id = wp_insert_comment($commentdata);
                        $existing_comment_ids[$comment->cid] = $new_comment_id;
                    }
                }                
            }
        }
    }
}
//FILMFESTIVAL IMPORT POSTS AND COMMENTS STARTS HERE..... 
die;
*/


//FILMCLUB IMPORT POSTS AND COMMENTS STARTS HERE..... 
/*   
$filmclub = $wpdb->get_results("SELECT * FROM node WHERE type='filmclub' ORDER BY created ASC");
if($filmclub)
{
    foreach($filmclub as $filmclubs)
    {
        $filmclub_content = $wpdb->get_results("SELECT * FROM node_revisions WHERE nid = ".$filmclubs->nid." ORDER BY timestamp DESC LIMIT 1");
        $filmclucb_video = $wpdb->get_results("SELECT * FROM content_field_discussion_video_embed WHERE nid = ".$filmclubs->nid."");
        $filmclucb_trailer = $wpdb->get_results("SELECT * FROM content_field_discussion_video_embed_pre WHERE nid = ".$filmclubs->nid."");
        
        $filmclub_trailer = $filmclucb_trailer[0]->field_discussion_video_embed_pre_value;
        $filmclub_video   = $filmclucb_video[0]->field_discussion_video_embed_value;
        
        $pub_date = date("Y-m-d H:i:s", $filmclubs->created);
        $post_content = array(
            'post_title'    => wp_strip_all_tags($filmclubs->title),
            'post_date'  => $pub_date,
            'post_content' => $filmclub_content[0]->body,
            'post_excerpt' => strip_tags($filmclub_content[0]->teaser),
            'post_type' => "filmclub",
            'post_status' => 'publish'
        );
        $postId = wp_insert_post($post_content);
        if($postId)
        {
            update_post_meta($postId, "meta_type_filmclub_video", $filmclub_video);
            update_post_meta($postId, "meta_type_filmclub_shorttrailer", $filmclub_trailer);

            echo "<strong>Title: ".$filmclubs->title."</strong><br/>";
            $comments = $wpdb->get_results("SELECT * FROM comments where nid = ".$filmclubs->nid. " ORDER BY timestamp ASC");
            $existing_comment_ids = array();
            $new_comment_ids = array();
            foreach($comments as $comment)
            {
                if($comment->pid == 0)
                {
                    $commentdata = array(
                        'comment_post_ID' => $postId, 
                        'comment_author' => $comment->name, 
                        'comment_author_email' => $comment->mail, 
                        'comment_author_IP' => $comment->hostname,
                        'comment_content' => $comment->comment, 
                        'comment_parent' => 0, 
                        'user_id' => '', 
                        'comment_date' => date("Y-m-d H:i:s", $comment->timestamp),
                        'comment_approved' => 1,
                    );

                    $new_comment_id = wp_insert_comment($commentdata);
                    $existing_comment_ids[$comment->cid] = $new_comment_id;
                }                
            }

            foreach($comments as $comment)
            {
                if($comment->pid != 0)
                {
                    if(array_key_exists($comment->pid, $existing_comment_ids))
                    {
                        $parent_id = $existing_comment_ids[$comment->pid];
                        $commentdata = array(
                            'comment_post_ID' => $postId, 
                            'comment_author' => $comment->name, 
                            'comment_author_email' => $comment->mail, 
                            'comment_author_IP' => $comment->hostname,
                            'comment_content' => $comment->comment, 
                            'comment_parent' => $parent_id,
                            'user_id' => '', 
                            'comment_date' => date("Y-m-d H:i:s", $comment->timestamp),
                            'comment_approved' => 1,
                        );
                        $new_comment_id = wp_insert_comment($commentdata);
                        $existing_comment_ids[$comment->cid] = $new_comment_id;
                    }
                }                
            }
        }        
    }
}
//FILMCLUB IMPORT POSTS AND COMMENTS ENDS HERE..... 
die;
*/

//Magazine article comment Import Process - Starts here//
/*
$issues = $wpdb->get_results("SELECT * FROM node WHERE type='issue' ORDER BY created ASC");
if($issues)
{
    $live_magazine_issues = array();
    foreach($issues as $issue)
    {
        $live_magazine_issues[$issue->vid] = $issue->title;
    }
}

$magazine_issues = get_magazine_issue_terms();
if($magazine_issues)
{
    foreach($magazine_issues as $magazine_issue)
    {
        $records = new WP_Query(
                    array(
                        "post_type"=>MAGAZINE_POST_TYPE, 
                        "posts_per_page"=>-1, 
                        'tax_query' => array(
                            array(
                                'taxonomy' => MAGAZINE_POST_ISSUE_TAXONOMY,
                                'field' => 'slug',
                                'terms' => $magazine_issue->slug
                            )
                        )
                    )
                );
        
        if($records->have_posts())
        {
            $loop = 1;
            $record_array = array();
            while($records->have_posts())
            {
                $records->the_post();
                $record_array[get_the_ID()] = trim(get_the_title());
            }
        }
        
        echo "<strong>Issue: ".$magazine_issue->name."</strong><br/>";
        $issue_id = array_search($magazine_issue->name, $live_magazine_issues);
        
        $issue_articles = $wpdb->get_results("SELECT * FROM nodehierarchy where parent = ".$issue_id);
        if($issue_articles)
        {
            $temp_article_ids = array();
            foreach($issue_articles as $issue_article)
            {
                $temp_article_ids[] = $issue_article->nid;
            }
            
            $stories = $wpdb->get_results("SELECT * FROM node where nid IN (".implode(", ", $temp_article_ids).") ORDER BY created");
            if($stories)
            {
                foreach($stories as $story)
                {
                    $postId = array_search(trim($story->title), $record_array);
                    
                    if($postId)
                    {
                        echo "<strong>Title: ".$story->title."</strong><br/>";
                        $comments = $wpdb->get_results("SELECT * FROM comments where nid = ".$story->nid. " ORDER BY timestamp ASC");
                        $existing_comment_ids = array();
                        $new_comment_ids = array();
                        foreach($comments as $comment)
                        {
                            if($comment->pid == 0)
                            {
                                $commentdata = array(
                                    'comment_post_ID' => $postId, 
                                    'comment_author' => $comment->name, 
                                    'comment_author_email' => $comment->mail, 
                                    'comment_author_IP' => $comment->hostname,
                                    'comment_content' => $comment->comment, 
                                    'comment_parent' => 0, 
                                    'user_id' => '', 
                                    'comment_date' => date("Y-m-d H:i:s", $comment->timestamp),
                                    'comment_approved' => 1,
                                );

                                $new_comment_id = wp_insert_comment($commentdata);
                                $existing_comment_ids[$comment->cid] = $new_comment_id;
                            }                
                        }

                        foreach($comments as $comment)
                        {
                            if($comment->pid != 0)
                            {
                                if(array_key_exists($comment->pid, $existing_comment_ids))
                                {
                                    $parent_id = $existing_comment_ids[$comment->pid];
                                    $commentdata = array(
                                        'comment_post_ID' => $postId, 
                                        'comment_author' => $comment->name, 
                                        'comment_author_email' => $comment->mail, 
                                        'comment_author_IP' => $comment->hostname,
                                        'comment_content' => $comment->comment, 
                                        'comment_parent' => $parent_id,
                                        'user_id' => '', 
                                        'comment_date' => date("Y-m-d H:i:s", $comment->timestamp),
                                        'comment_approved' => 1,
                                    );
                                    $new_comment_id = wp_insert_comment($commentdata);
                                    $existing_comment_ids[$comment->cid] = $new_comment_id;
                                }
                            }                
                        }
                    }
                }
            }
        }
    }
}
//Magazine article comment Import Process - Ends here//
die;
*/

//Blog Import Process - Starts here//
/*
$stories = $wpdb->get_results("SELECT * FROM node WHERE node.type='blog_post' ORDER BY node.created DESC");
if($stories)
{
    foreach($stories as $story)
    {
        $pub_date = date("Y-m-d H:i:s", $story->created);
        $subtitles = $wpdb->get_results("SELECT * FROM content_field_subtitle WHERE nid = ".$story->nid." ORDER BY vid DESC LIMIT 1");
        $content = $wpdb->get_results("SELECT * FROM node_revisions WHERE nid = ".$story->nid." ORDER BY timestamp DESC LIMIT 1");
        
        $my_post = array(
                'post_title'    => wp_strip_all_tags($story->title),
                'post_date'  => $pub_date,
                'post_content' => $content[0]->body,
                'post_excerpt' => strip_tags($subtitles[0]->field_subtitle_value),
                'post_type' => "post",
                'post_status' => 'publish'
            );
        $postId = wp_insert_post($my_post);
        $comments = $wpdb->get_results("SELECT * FROM comments where nid = ".$story->nid. " ORDER BY timestamp ASC");
        if($comments)
        {
            $existing_comment_ids = array();
            $new_comment_ids = array();
            foreach($comments as $comment)
            {
                if($comment->pid == 0)
                {
                    $commentdata = array(
                        'comment_post_ID' => $postId, 
                        'comment_author' => $comment->name, 
                        'comment_author_email' => $comment->mail, 
                        'comment_author_IP' => $comment->hostname,
                        'comment_content' => $comment->comment, 
                        'comment_parent' => 0, 
                        'user_id' => '', 
                        'comment_date' => date("Y-m-d H:i:s", $comment->timestamp),
                        'comment_approved' => 1,
                    );
                    
                    $new_comment_id = wp_insert_comment($commentdata);
                    $existing_comment_ids[$comment->cid] = $new_comment_id;
                }                
            }
            
            foreach($comments as $comment)
            {
                if($comment->pid != 0)
                {
                    if(array_key_exists($comment->pid, $existing_comment_ids))
                    {
                        $parent_id = $existing_comment_ids[$comment->pid];
                        $commentdata = array(
                            'comment_post_ID' => $postId, 
                            'comment_author' => $comment->name, 
                            'comment_author_email' => $comment->mail, 
                            'comment_author_IP' => $comment->hostname,
                            'comment_content' => $comment->comment, 
                            'comment_parent' => $parent_id,
                            'user_id' => '', 
                            'comment_date' => date("Y-m-d H:i:s", $comment->timestamp),
                            'comment_approved' => 1,
                        );
                        $new_comment_id = wp_insert_comment($commentdata);
                        $existing_comment_ids[$comment->cid] = $new_comment_id;
                    }
                }                
            }
        }        
    }
}
//Blog Import Process - Ends here//
die;
*/
?>