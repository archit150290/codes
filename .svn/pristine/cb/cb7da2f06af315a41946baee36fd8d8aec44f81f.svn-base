<?php
/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

class options_page {
    
    function __construct() {
        add_action('admin_menu', array($this, 'admin_menu'));
    }

    function admin_menu() {
        add_options_page('Page Title', 'Tricycle Settings', 'manage_options', 'options_page_slug', array(
            $this,
            'settings_page'
                )
        );
        
       add_submenu_page('marqueepage', 'Ebooks Home Page Articles', 'Ebooks Home Page Articles', 'manage_options', 'ebooksmanager', array($this,'ebooks_homepage_manager'));
    }

    function settings_page() {
        
        $upload_dir = wp_upload_dir();
        $upload_url = $upload_dir['baseurl'];
        wp_enqueue_media();
        
        
        if (isset($_REQUEST['submit'])) {
            
            $regulator = isset($_REQUEST['film_regulator']) ? $_REQUEST['film_regulator'] : "0";
            update_option("film_regulator", $regulator);
            
            $subscribeheadline = $_REQUEST['subscribeheadline'];
            update_option("settings-subscribeheadline", $subscribeheadline);
            
           
            $subscribetext = $_REQUEST['subscribetext'];
            update_option("settings-subscribetext", $subscribetext);
            
           
            if(!empty($_REQUEST['subscribeboxhidden'])){
            $background_file_url = $_REQUEST['subscribeboxhidden'];
            $file_array = explode($upload_url, $background_file_url);
            $subscribeimage = substr($file_array[1], 1);
            update_option("settings-subscribeimage", $subscribeimage); 
            }
            else
            {
             update_option("settings-subscribeimage", ""); 
            }
                
            
           
            $enewssignupheadline = $_REQUEST['enewssignupheadline'];
            update_option("settings-enewsheadline", $enewssignupheadline);
            
           
            $enewssignuptext = $_REQUEST['enewssignuptext'];
            update_option("settings-enewstext", $enewssignuptext);
            
            if(!empty($_REQUEST['enewssignupboxhidden'])){
            $background_file_url1 = $_REQUEST['enewssignupboxhidden'];
            $file_array1 = explode($upload_url, $background_file_url1);
            $enewssignupimage = substr($file_array1[1], 1);
            update_option("settings-enewsimage", $enewssignupimage);
            }
            else
            {
             update_option("settings-enewsimage", ""); 
            }
            
            
            $footersubscribeheadline = $_REQUEST['footersubscribeheadline'];
            update_option("settings-footersubscribeheadline", $footersubscribeheadline);
            
            
            $footersubscribetext = $_REQUEST['footersubscribetext'];
            update_option("settings-footersubscribetext", $footersubscribetext);
            
            
            $footernewslettertext = $_REQUEST['footernewslettertext'];
            update_option("settings-footernewslettertext", $footernewslettertext);
            
            $footerdonatetext = $_REQUEST['footerdonatetext'];
            update_option("settings-footerdonatetext", $footerdonatetext);
            
        }
        
        $subscribeheadline_key = get_option( 'settings-subscribeheadline' );
        $subscribetext_key = get_option( 'settings-subscribetext' );
        $subscribeimage_key = get_option( 'settings-subscribeimage' );
        if($subscribeimage_key)
        {
            $subscriber_image = $upload_url.'/'.$subscribeimage_key;
        }
        $enewssignupheadline_key = get_option( 'settings-enewsheadline' );
        $enewssignuptext_key = get_option( 'settings-enewstext' );
        $enewssignupimage_key = get_option( 'settings-enewsimage' );
        if($enewssignupimage_key)
        {
            $enewssignupimage = $upload_url.'/'.$enewssignupimage_key;
        }
        $footersubscribeheadline_key = get_option( 'settings-footersubscribeheadline' );
        $footersubscribetext_key = get_option( 'settings-footersubscribetext' );
        $footernewslettertext_key = get_option( 'settings-footernewslettertext' );
        $footerdonatetext_key = get_option( 'settings-footerdonatetext' );
        
        ?>
        <script type="text/javascript">
        
            function meta_imagebox(title, inputboxhidden, inputimage)
            {   
                var meta_image_frame_settings;
                meta_image_frame_settings = wp.media.frames.meta_image_frame_settings = wp.media({
                title: title,
                button: { text:  title },
                multiple: false
                }) 
                .on('select',function(){
                var attachment = meta_image_frame_settings.state().get('selection').first().toJSON();
                jQuery("#"+inputimage).attr('src', attachment.url);
                //jQuery("#"+removeimage).text("Remove Image");
                jQuery("#"+inputboxhidden).val(attachment.url); 
                })
                meta_image_frame_settings.open();
            }
            
            function removeimage(removetag, getinputbox, getimage)
            {
                jQuery("#"+getinputbox).val("");
                jQuery("#"+getimage).attr('src', "");
                jQuery("#"+removetag).remove();
            }
        
        </script>

        <div class="wrap"> 
            <h1>Tricycle Settings</h1>
            <form action="" method="post">
                <h3>Please Tick the Checkbox to Switch On/Off Film Festival</h3>
                <?php $film_regulator = get_option("film_regulator"); ?>
                <table class="form-table">
                <tr>
                    <td><label><input type="checkbox" value="1" name="film_regulator" id="film_regulator" <?php echo ($film_regulator == "1") ? "checked" : ""; ?>  /> Set Film Festival Up</label></td>
                </tr></table>
           

      
                <h3>Subscribe Module</h3>
                <table class="form-table">
                <tbody>
                <tr>
                <th scope="row"><label for="blogname">Headline</label></th>
                <td><input type="text" class="regular-text" id="subscribeheadline" name="subscribeheadline" value="<?php echo $subscribeheadline_key;?>"></td>
                </tr>
                <tr>
                <th scope="row"><label for="blogname">Text</label></th>
                <td><textarea cols="39" id="subscribetext" name="subscribetext"><?php echo $subscribetext_key;?></textarea></td>
                </tr>
                <tr>
                <th scope="row"><label for="blogname">Image</label></th>
                <input readonly type="hidden" class="regular-text" id="subscribeboxhidden" name="subscribeboxhidden" value="<?php if($subscribeimage_key) { echo $subscriber_image; }?>">
                <td><img id="subscribeimage" alt="" src="<?php echo $subscriber_image; ?>" width="150px"><input type="button" onclick="meta_imagebox('Subscribe-Module', 'subscribeboxhidden', 'subscribeimage')" class="button button-primary" value="Upload Image"><?php if($subscribeimage_key){?><div><a id="removeimagesubscribe" onclick="removeimage('removeimagesubscribe','subscribeboxhidden', 'subscribeimage')">Remove Image</a></div><?php } ?></td>
                </tr>
                </tbody>
                </table>
          

       
                <h3>Enews Signup</h3>
                <table class="form-table">
                <tbody>
                <tr>
                <th scope="row"><label for="blogname">Headline</label></th>
                <td><input type="text" class="regular-text" id="enewssignupheadline" name="enewssignupheadline" value="<?php echo $enewssignupheadline_key;?>"></td>
                </tr>
                <tr>
                <th scope="row"><label for="blogname">Text</label></th>
                <td><textarea cols="39" id="enewssignuptext" name="enewssignuptext"><?php echo $enewssignuptext_key;?></textarea></td>
                </tr>
                <tr>
                <th scope="row"><label for="blogname">Image</label></th>
                <input type="hidden" class="regular-text" id="enewssignupboxhidden" name="enewssignupboxhidden" value="<?php if($enewssignupimage_key) { echo $enewssignupimage; }?>"> 
                <td><img id="enewsimage" src="<?php echo $enewssignupimage ;?>" alt="" width="150px"><input type="button" onclick="meta_imagebox('Enews-Signup', 'enewssignupboxhidden','enewsimage')" class="button button-primary" value="Upload Image"><?php if($enewssignupimage_key) { ?><div><a id="removeimageenews" onclick="removeimage('removeimageenews','enewssignupboxhidden', 'enewsimage')">Remove Image</a></div><?php } ?></td>
                </tr>
                </tbody>
                </table>
                
                <h3>Footer Subscribe Today</h3>
                <table class="form-table">
                <tbody>
                <tr>
                <th scope="row"><label for="blogname">Headline</label></th>
                <td><input type="text" class="regular-text" id="subscribeheadline" name="footersubscribeheadline" value="<?php echo $footersubscribeheadline_key;?>"></td>
                </tr>
                <tr>
                <th scope="row"><label for="blogname">Text</label></th>
                <td><textarea cols="39" id="footersubscribetext" name="footersubscribetext"><?php echo $footersubscribetext_key;?></textarea></td>
                </tr>
                </table>
                
                <h3>Footer Weekly Newsletter</h3>
                <table class="form-table">
                <tbody>
                <tr>
                <th scope="row"><label for="blogname">Headline</label></th>
                <td><textarea cols="39" id="footernewslettertext" name="footernewslettertext"><?php echo $footernewslettertext_key;?></textarea></td>
                </tr>
                
                </tbody>
                </table>
                
                <h3>Footer Donate</h3>
                <table class="form-table">
                <tbody>
                <tr>
                <th scope="row"><label for="blogname">Text</label></th>
                <td><textarea cols="39" id="footerdonatetext" name="footerdonatetext"><?php echo $footerdonatetext_key;?></textarea></td>
                </tr>
                
                </tbody>
                </table>
                <p class="submit"> 
                 <label><input class="button button-primary" type="submit" name="submit" value="Save Changes"></label>
                </p>
            </form>
        </div>
   
        <?php
    }
    
    /* ebooks Home page manager*/
    
    function ebooks_homepage_manager()
    {
            if(isset($_REQUEST['submit']))
            { 
               
                $check_status = array();
                $resultant = array();
                $postId = json_decode($_REQUEST['post_id']);
                
                for($i=0; $i<count($postId);$i++)
                {   
                    if(empty($_REQUEST['check_status_'.$postId[$i]]))
                    {
                        delete_post_meta($postId[$i], "ebooks_meta_homepage");
                    }
                }
            }
        global $wpdb;
        $results = $wpdb->get_results("SELECT * FROM ".$wpdb->prefix."postmeta as meta inner join ".$wpdb->prefix."posts as ptable on ptable.ID=meta.post_id where meta.meta_key = 'ebooks_meta_homepage'  order by meta.meta_id DESC");
        $check_status = array();
        ?>
        <div class="wrap">
            <h3>Manage Ebooks Home Page Articles Setting.</h3>
    <form method="post" action="">
        <table id="marquee" class="widefat">
            
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Checker</th>
                </tr>
            </thead>
            
            <tbody>
                <?php 
                $postId = array();
                foreach($results as $result)
                {   
                    $post_id = $result->post_id;
                    $postId[] =  (int)$result->post_id;
                    
                    $post_title = $result->post_title ;?>
                    <tr>
                        <td><?php echo $post_title;?></td>
                        <td><input type="checkbox" value="1" name="check_status_<?php echo $post_id;?>" id="ebooks_meta_homepage" checked="checked"></td>
                    </tr>
                <?php }
                ?>
                <input type="hidden" id="post_id" name="post_id" value='<?php echo json_encode($postId); ?>'>
            </tbody>
            
            <tfoot>
                <tr>
                    <th>Title</th>
                    <th>Checker</th>
                </tr>
            </tfoot>
           
        </table><br>  
            <?php if($results){?>
            <label><input class="button button-primary" type="submit" value="Update" name="submit" /></label>
            <?php } ?>
    </form>
        </div>    
    <?php 
    }

}
new options_page;
?>
