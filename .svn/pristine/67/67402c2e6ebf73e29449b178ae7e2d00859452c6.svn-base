// prime variables
////////////////////////

// functions
////////////////////////

// toggle sticky header for desktop
function stickyHead() {
    // if desktop header is visible
    if ($('.header-desktop').css('display') == 'block') {
        //and it's off screen
        if ($(window).scrollTop() > 120) {
            // slide down mobile header
            $('.header-mobile').slideDown(300, function () {
                // add shadow
                $('.header-mobile').addClass('header-fixed');
            });
        } else {
            // remove shadow
            $('.header-mobile').removeClass('header-fixed');
            // slide up mobile header
            $('.header-mobile').slideUp(300, function () {
                $('.header-mobile').css('display', '');
            });
        }
    }
}

// swap stack columns
function swapStack(stackModule) {
    if ($(stackModule + ' figure').css('float') == 'left') {
        $(stackModule + ' .rubric').each(function () {
            $(this).after($(this).siblings($('figure')));
        });
    } else {
        $(stackModule + ' figure').each(function () {
            $(this).after($(this).siblings($('.rubric')));
        });
    }
}

// enews modal
function modal(dept) {
    // pull value from email input
    var email = $('#' + dept + '-email').val();
    // turn on modal
    $('#' + dept + '-modal-switch').prop('checked', true);
    //insert email in modal input
    $('#' + dept + '-modal-email').attr('value', email);
}

// video player
function video(dept) {

    var keyHeight = $(dept + ' img').outerHeight();
    // console.log(dept + ': ' + keyHeight);
    $(dept + ' .icon-video_play').css('height', keyHeight);
    $('.related-posts article').matchHeight._update();

}

function videoPlay(dept) {
    $(dept + ' .icon-video_play').click(function () {
        var videosrc = $(this).attr('rel');
        if(videosrc=="")
        {
            alert("Behind the paywall");
            return false;
        }
        $(dept + ' main section').css('margin', '0 0 1.2em');
        $(dept + ' .icon-video_play').css('display', 'none');
        $(dept + ' img').css('display', 'none');
        $(dept + ' .video-wrapper').css('display', 'block');
        $(dept + ' .video-wrapper').html('<iframe src="' + videosrc + '?autoplay=1&title=0&byline=0&portrait=0" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>');
    });
}

// align landing_blog marquee hero
function alignMarquee() {
    var cardHeight = $('.landing-marquee-hero section').outerHeight();
    var imgHeight = $('.landing-marquee-hero img').outerHeight();

    if ($('.landing-marquee-hero figure a').css('display') == 'block') {
        $('.landing-marquee-hero img').css('height', cardHeight + 76.8 + 'px');
    } else if ($('.landing-marquee-hero figure a').css('display') !== 'block' && $('.landing-marquee-hero figure').css('float') == 'left') {
        $('.landing-marquee-hero img').css('height', cardHeight + 'px');
    } else {
        $('.landing-marquee-hero img').css('height', '');
    }
}

function navigate_posts(nextpost)
{
    var moveto = nextpost;

    if (moveto != "") {
        window.location.href = moveto;
    } else {
        return false;
    }
}

/*
 load more on ebooks
 */

function loadmoreajax(searchyear, postId, postType, url)
{
    $.ajax({
        type: "GET",
        data: {searchyear: searchyear, postid: postId, posttype: postType},
        url: url,
        success: function (result) {
            jQuery("#loadMore").remove();
            jQuery("#moredata").append(result);

        },
    });

}


//ajax call to load more posts
function loadmoretopic(){
            var postId=jQuery("#postId").val();
            var taxName=jQuery("#taxname").val();
            var taxonomy=jQuery("#taxonomy").val();
            jQuery("#PleaseLoadMore").remove();
            jQuery("#loadingimage").show();
            jQuery.ajax({
            type: 'POST',
            url: ajax_url,
            data: {
                action: 'loadmoreajax',
                postId: postId,
                taxname: taxName,
                taxonomy:taxonomy,
            },
            success: function (data, textStatus, XMLHttpRequest) {
                jQuery("#postId").remove();
                jQuery("#loadingimage").remove();
                //jQuery("#PleaseLoadMore").remove();
                jQuery(".landing-stack").append(data);
            },
            error: function (MLHttpRequest, textStatus, errorThrown) {
            alert(errorThrown);
            }
        });
    
 }

 function loadmorearchive(){
            var postId=jQuery("#postId").val();
            var posttype=jQuery("#posttype").val();
            var searchyear=jQuery("#searchyear").val();
            jQuery("#archiveloadmore").parent().remove();
            jQuery("#loadingimage").show();
            jQuery.ajax({
            type: 'POST',
            url: ajax_url,
            dataType: 'json',
            data: {
                action: 'archiveloadmore',
                postId: postId,
                posttype: posttype,
                searchyear:searchyear,
            },
            success: function (data, textStatus, XMLHttpRequest) {
                jQuery("#postId").remove();
               // jQuery("#archiveloadmore").parent().remove();
                jQuery("#loadingimage").hide();
                console.log(data['html'])
                jQuery("#moredata").append(data['html']);
                jQuery("#moredata").parent().append(data['pager']);
            },
            error: function (MLHttpRequest, textStatus, errorThrown) {
            alert(errorThrown);
            }
        });
  
   }
   
   function LoadMoreMagazine()
   {
       var Topicstermid=jQuery("#TopicstermId").val();
       jQuery("#loadingimage").show();
       jQuery("#loadmoremagazine").parent().remove();
       jQuery.ajax({
            type: 'POST',
            url: ajax_url,
            dataType: 'json',
            data: {
                action: 'MagazineLoadMore',
                Topicstermid: Topicstermid,
               },
            success: function (data, textStatus, XMLHttpRequest) {
               jQuery("#TopicstermId").remove();
               jQuery("#loadingimage").remove();
               //jQuery("#loadmoremagazine").parent().remove();
               //jQuery("#moredata").append(data);
               jQuery("#moredata").append(data['html']);
               jQuery("#moredata").parent().append(data['pager']);
              
            },
            error: function (MLHttpRequest, textStatus, errorThrown) {
            alert(errorThrown);
            }
        });
   }
   
   function LoadMoreTrikedaily()
   {
        var PostId=jQuery("#postId").val();
        
        jQuery("#trikedailyloadmore").remove();
        jQuery("#loadingimage").show();
        jQuery.ajax({
            type: 'POST',
            url: ajax_url,
            data: {
                action: 'TrikeDailyLoadMore',
                postId: PostId,
               },
            success: function (data, textStatus, XMLHttpRequest) {
               jQuery("#postId").remove();
               jQuery("#loadingimage").remove();
               jQuery(".landing-stack").append(data);
               
            },
            error: function (MLHttpRequest, textStatus, errorThrown) {
            alert(errorThrown);
            }
        });
   
   }

// remove border left from time on landing articles w/o authors
// function noTimeBorder() {
//   $('.landing-marquee article, .landing-stack article').each(function() {
//     if($(this).find('address').length === 0) {
//       $(this).find('time').addClass('null-topic-1line');
//     }
//   });
// }

// BEGIN
////////////////////////
$(document).ready(function () {

    // sticky header – mobile
    $(window).scroll(function () {
        if ($(window).scrollTop() > 0) {
            $('.header-mobile').addClass('header-fixed');
        } else {
            $('.header-mobile').removeClass('header-fixed');
        }
    });

    // sticky header – desktop
    stickyHead();
    $(window).scroll(stickyHead);

    // functions that need to listen for window resize
    $(window).on('load resize', function () {

        // swapping columns in home stack lockup
        swapStack('.home-trikedaily');
        swapStack('.landing-stack');

        // fixing video
        video('.home-dharmatalks');
        video('.home-filmclub');
        video('.article-video_featured');
        video('.landing-marquee article.dharmatalks');
        video('.landing-marquee article.filmclub');
        video('.landing-marquee article.filmfestival');
        video('.landing-marquee_video');
        video('.landing-stack_video');
        video('.landing-stack article.dharmatalks');
        video('.landing-stack article.filmclub');
        video('.landing-stack article.filmfestival');
        video('.archive-cover_dharmatalks');
        video('.archive-cover_filmclub');
        video('.related-posts article.dharmatalks');
        video('.related-posts article.filmclub');
        video('.related-posts article.filmfestival');
        video('.aside-dharmatalks');
        video('.aside-filmclub');
        video('.aside-filmfestival');

        // vertically aligning marquee feature
        // on landing_trikedaily
        alignMarquee();
    });

    // playing video
    videoPlay('.home-dharmatalks');
    videoPlay('.home-filmclub');
    videoPlay('.article-video_featured');

    // matchHeight
    $('.home-marquee aside article').matchHeight();
    $('.home-magazine article').matchHeight();
    $('.home-dharmatalks article').matchHeight();
    $('.related-posts article').matchHeight();
    $('.action').matchHeight();
    $('.landing-marquee-articles article').matchHeight();
    $('.rubric_small').matchHeight();
    $('.aside-depts > section article').matchHeight();


    // toggle nav drawer
    $('.icon-nav, .nav-drawer-fade-screen, .icon-close').on('click', function () {
        $('.nav-drawer, .nav-drawer-fade-screen').toggleClass('is-visible');
    });

    // open login field in nav drawer
    $('.nav-subs h1').click(function () {
        $('.nav-subs form').slideToggle(200, function () {
            $('.nav-subs form .email').focus();
        });
    });

    // open login field in header desktop
    $('.header-desktop .login-link').click(function () {
        if ($('.header-desktop .search').css('display') == 'list-item') {
            $('.header-desktop .search').slideUp(200);
            $('.header-desktop .login').slideDown(200, function () {
                $('.header-desktop .email').focus();
            });
            $('.header-desktop .login-link').css('color', '#ccc');
        } else {
            $('.header-desktop .email').blur();
            $('.header-desktop .login').slideUp(200);
            $('.header-desktop .search').slideDown(200);
            $('.header-desktop .login-link').css('color', '');
        }
    });

    // open search field on mobile
    $('.nav-right.icon-search').click(function () {
        if ($('.mobile-search').css('display') == 'list-item') {
            $('.mobile-search input').blur();
            $('.mobile-search').slideUp(200, function () {
                $('.mobile-search').css('display', '');
            });
            $('.nav-right.icon-search svg').css('fill', '#998');
        } else {
            $('.mobile-search').slideDown(200, function () {
                $('.mobile-search input').focus();
            });
            $('.nav-right.icon-search svg').css('fill', '#fff');
        }
    });

    // hide search field on mobile
    $('.wrap').click(function () {
        if ($('.mobile-search').css('display') == 'list-item') {
            $('.mobile-search input').blur();
            $('.mobile-search').slideUp(200);
            $('.nav-right.icon-search svg').css('fill', '#998');
        }
    });

    // MODALS
    // enews modals
    $('#action-enews').submit(function (e) {
        e.preventDefault();
        modal('action');
    });
    // daily dharma modal
    $('#dailydharma-enews').submit(function (e) {
        e.preventDefault();
        modal('dailydharma');
    });
    //close modal
    $('.modal-fade-screen, .modal-close').on('click', function () {
        $('.modal-state:checked').prop('checked', false).change();
    });
    $('.modal-inner').on('click', function (e) {
        e.stopPropagation();
    });

    // DROPDOWN
    $('.dropdown-button').click(function () {
        var $button, $menu;
        $button = $(this);
        $menu = $button.siblings('.dropdown-menu');
        $menu.toggleClass('show-menu');
        $menu.children('li').click(function () {
            //$menu.removeClass('show-menu');
            //$button.html($(this).html());
        });
    });

    $('.js_playvideo').click(function () {

        var videosrc = $(this).attr('rel');
        if(videosrc=="")
        {
            alert("Behind the paywall");
            return false;
        }
        var dept = ".article-video_featured";
        $('.article_playlist').find('h1').removeClass('play');
        $(this).find('h1').addClass('play');
        
        var videoTitle = $(this).attr('videotitle');
        $('.js_videoTitle').text(videoTitle);
        
        var videonum = $(this).attr('videonumber');
        $('.videonum').text(videonum);
        
        var pdf_video = $(this).attr('linkpdf');
        if(pdf_video!=""){
            var downloadlink = downloadpdf+pdf_video;
            $("#pdf_download").attr("href",downloadlink);
        }
        
        $(dept + ' main section').css('margin', '0 0 1.2em');
        $(dept + ' .icon-video_play').css('display', 'none');
        $(dept + ' img').css('display', 'none');
        $(dept + ' .video-wrapper').css('display', 'block');
        $(dept + ' .video-wrapper').html('<iframe src="' + videosrc + '?autoplay=1&title=0&byline=0&portrait=0" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>');

    });


    $('li.yeardropdown').click(function () {
        var year = $(this).attr('rel');
        if (year != "") {
            var currentUrl = pageurl;
            window.location.href = currentUrl + year;
        } else {
            return false;
        }

    });

});
