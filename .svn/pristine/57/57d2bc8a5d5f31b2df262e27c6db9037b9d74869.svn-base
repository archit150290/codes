<?php get_header(); ?>
<?php
$tax = $wp_query->get_queried_object();
$tax_name = $tax->name;
//applying query
$args = array(
    'post_type' => array('post', EBOOKS_POST_TYPE, ARTICLE_POST_TYPE, FILM_CLUB_POST_TYPE, DHARMATALKS_POST_TYPE),
    'tax_query' => array(
        'relation' => 'AND',
        array(
            'taxonomy' => 'topic',
            'field' => 'slug',
            'terms' => $tax_name,
            'operator' => 'IN',
        ),
    ),
    'post_status' => 'publish',
    'order' => 'DESC',
    'orderby' => 'date',
    'posts_per_page' => 3,
);
$eq_query = new WP_Query($args);
?>
<!-- start content -->
<div class='wrap'>
    <!-- start landing marquee -->
    <div class='landing-marquee'>
        <header class='rubric_top'>
            <h1><?php echo $tax_name; ?></h1>
        </header>

        <main class='landing-marquee-articles'>

            <?php
            while ($eq_query->have_posts()): $eq_query->the_post();
                $post_type = get_post_type();
                if ($post_type == "post") {
                    $post_type = "trikedaily";
                } else if ($post_type == "dharma-talks") {
                    $post_type = "dharmatalks";
                } else if ($post_type == "film-club") {
                    $post_type = "filmclub";
                }else if ($post_type == "film-festival") {
                    $post_type = "filmfestival";
                } else {
                    $post_type;
                }
                $postId[] = $eq_query->post->ID;
                $byline = get_post_meta($post->ID, 'authors_select_metabox', true);
                $byauthor = get_post_meta($post->ID, 'authors_name_metabox', true);
                $topic = get_the_terms(get_the_ID(), "topic");
                // pr($topic);
                $topicName = isset($topic[0]) ? $topic[0]->name : '';
                $topicSlug = isset($topic[0]) ? $topic[0]->slug : '';
                ?>
                <article class = '<?php echo $post_type; ?>' >
                    <figure>
                        <a href = '#'>
                             <?php if($post_type=="filmclub" || $post_type=="dharmatalks") { echo "<div class='icon-video_play' data-grunticon-embed></div>"; } ?>
                             <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '','(min-width: 50em) 33vw,100vw'); ?>
                        </a>
                    </figure>
                    <section class = 'rubric <?php echo $post_type; ?>'>
                        <a class = 'icon icon-dept_<?php echo $post_type; ?>' href = '#'></a>
                        <h2 class = '<?php echo $post_type; ?>'><a href = '#'><?php echo $post_type; ?></a><span class = 'topic'><a href = '<?php echo getTopicUrl($topicSlug); ?>'><?php echo $topicName; ?></a></span></h2>
                    </section>
                    <section class = 'titles'>
                        <h1><a href = <?php the_permalink(); ?>><?php the_title(); ?></a></h1>
                        <p><?php
                            if ($post_type != 'dharmatalks') {
                                if ($post_type == "filmclub") {
                                    echo "";
                                } else {
                                    the_excerpt();
                                }
                            }
                            ?></p>
                        <address><?php
                            echo $byline . " " . $byauthor;
                            ?></address>
                        <time><?php echo get_the_date('M d, Y'); ?></time>
                    </section>
                </article>

                <?php
            endwhile;
            wp_reset_query();
            ?> 
        </main>
    </div>
    <!-- end landing marquee -->

    <!-- start landing stack -->
    <div class='landing-stack'>

        <?php
        if (!empty($postId[0])) {
            $args = array(
                'post_type' => array('post', ARTICLE_POST_TYPE, EBOOKS_POST_TYPE, FILM_CLUB_POST_TYPE),
                'tax_query' => array(
                    'relation' => 'AND',
                    array(
                        'taxonomy' => 'topic',
                        'field' => 'slug',
                        'terms' => $tax_name,
                        'operator' => 'IN',
                    ),
                ),
                'post_status' => 'publish',
                'post__not_in' => $postId,
                'order' => 'DESC',
                'orderby' => 'date',
                'posts_per_page' => 9,
            );
            $eq_query = new WP_Query($args);
            $count = 0;

            while ($eq_query->have_posts()): $eq_query->the_post();
//                echo $count;
                if ($count == "3") {
                    ?>
                    <div class = 'CTA-module'>
                        <div class = 'rule'></div>
                        <div class = 'CTA-ad' style = '
                             background-color: #ddd;
                             line-height: 1; padding: 2em;
                             margin: 0 auto;
                             width: 75%;
                             height: 10em;
                             text-align: center;
                             '>
                            <p>Call-to-Action Module. Can be set in the CMS to any of the following: (1) Ad served via Google DFP Small Business (TBD), (2) Daily Dharma, (3) Subscribe CTA, (4) Newletter CTA</p>
                        </div>
                        <div class = 'rule'></div>
                    </div>
                    <?php
                }
                $post_type = get_post_type();
                $post_type = get_post_type();
                if ($post_type == "post") {
                    $post_type = "trikedaily";
                } else if ($post_type == "film-club") {
                    $post_type = "filmclub";
                } else {
                    $post_type;
                }

                $byline = get_post_meta($post->ID, 'authors_select_metabox', true);
                $byauthor = get_post_meta($post->ID, 'authors_name_metabox', true);
                ?>
                <article class='<?php echo $post_type; ?>'>
                    <figure>
                        <a href='#'>
                            <?php if ($post_type == "filmclub") {
                                ?> <div class = 'icon-video_play' data-grunticon-embed></div> <?php } ?>
                            <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '','(min-width: 37.5em) 25vw, 100vw'); ?>
                        </a>
                    </figure>
                    <section class = 'rubric <?php echo $post_type; ?>'>
                        <a class = 'icon icon-dept_<?php echo $post_type; ?>' href = '#'></a>
                        <h2 class = '<?php echo $post_type; ?>'><a href = '#'><?php echo $post_type; ?></a><span class = 'topic'><a href = '#'><?php echo $tax_name; ?></a></span></h2>
                    </section>
                    <section class = 'titles'>
                        <h1><a href = <?php the_permalink(); ?>><?php the_title() ?></a></h1>
                        <p><?php echo excerpt(35); ?></p>
                        <address><?php echo $byline . " " . $byauthor; ?></address>
                        <time><?php
                            if ($post_type == "magazine") {
                                $issue = get_the_terms($post->ID, "magazine-issue");
                                echo $issue[0]->name;
                            } else {
                                the_date('M Y');
                            }
                            ?></time>
                    </section>
                </article>
                <?php
                $count++;
            endwhile;
            wp_reset_query();
            ?>
            <?php if ($count == "9") { ?>
                <div class='more'>
                    <!-- tax name, post type, url, post id's -->
                      <?php $url= get_template_directory_uri().'/loadmore-topic.php'; ?>
                    <a href='#'>Load More</a>
                </div>
            <?php } ?>

        <?php }
        ?> 


    </div>

    <div class = 'CTA-module'>
        <div class = 'rule'></div>
        <div class = 'CTA-ad' style = '
             background-color: #ddd;
             line-height: 1; padding: 2em;
             margin: 0 auto;
             width: 75%;
             height: 10em;
             text-align: center;
             '>
            <p>Call-to-Action Module. Can be set in the CMS to any of the following: (1) Ad served via Google DFP Small Business (TBD), (2) Daily Dharma, (3) Subscribe CTA, (4) Newletter CTA</p>
        </div>
        <div class = 'rule'></div>
    </div>
    <!--end Call to Action module -->

    <aside>

        <div class = 'aside-depts'>
            <!--start aside trikedaily -->
            <section class='aside-trikedaily'>
                <header class='rubric_small'>
                    <h1><a href='#'><span class='icon icon-dept_trikedaily'></span>Trike Daily</a></h1>
                    <p>Daily wisdom, teachings &amp; critique</p>
                </header>

                <main>
                    <?php
                    $args = array(
                        'post_type' => 'post',
                        'post_status' => 'publish',
                        'order' => 'DESC',
                        'orderby' => 'date',
                        'posts_per_page' => 1,
                            //  'post__not_in' =>$postId,
                    );
                    $eq_query = new WP_Query($args);
                    while ($eq_query->have_posts()) : $eq_query->the_post();
                        $topic = get_the_terms(get_the_ID(), "topic");
                        $topicName = isset($topic[0]) ? $topic[0]->name : "";
                        $topicSlug = isset($topic[0]) ? $topic[0]->slug : "";
                        ?>
                        <article>
                            <figure>
                                <a href='#'>
                                    <?php echo srcset_post_thumbnail(get_the_ID(),'image','','(min-width: 37.5em) 25vw, 100vw'); ?>
                                </a>
                            </figure>
                            <section>
                                <h2 class='rubric trikedaily'><span class='topic'><a href='<?php getTopicUrl($topicSlug); ?>'><?php echo $topicName; ?></a></span></h2>
                                <h1><a href='<?php the_permalink(); ?>'><?php echo get_the_title(); ?></a></h1>
                                <p><?php the_excerpt(); ?></p>
                                <address>By Romulus Jocelyne</address>
                                <time><?php echo get_the_date('M d, Y'); ?></time>
                            </section>
                        </article>

                        <?php
                    endwhile;
                    wp_reset_query();
                    ?>
                </main>
                <div class='rule-responsive'></div>
            </section>
            <!--end aside trikedaily -->

            <!--start aside magazine -->
            <section class='aside-magazine'>
                <header class='rubric_small'>
                    <h1><a href='#'><span class='icon icon-dept_magazine'></span>Magazine</a></h1>
                    <p>The Buddhist Review</p>
                </header>

                <main>
                    <?php
                    $args = array(
                        'posts_per_page' => 1,
                        'orderby' => 'post_date',
                        'order' => 'DESC',
                        'post_type' => ARTICLE_POST_TYPE,
                        'post_status' => 'publish',
                        'suppress_filters' => true
                    );

                    $querymagazine = new WP_Query($args);
                    query_posts($querymagazine);
                    while ($querymagazine->have_posts()) : $querymagazine->the_post();

                        $topicSet = get_the_terms(get_the_ID(), "topic");
                        $topicName = isset($topicSet[0]) ? $topicSet[0]->name : "";
                        $topicSlug = isset($topicSet[0]) ? $topicSet[0]->slug : "";

                        $issueSet = get_the_terms(get_the_ID(), "magazine-issue");
                        $issueName = isset($issueSet[0]) ? $issueSet[0]->name : "";
                        $issueSlug = isset($issueSet[0]) ? $issueSet[0]->slug : "";
                        ?>
                        <article>
                            <figure>
                                <a href='<?php the_permalink(); ?>'>
                                        <!--<img src='images/jpg/home-magazine_1x.jpg'
                                                srcset='images/jpg/home-magazine_2x.jpg 1000w,
                                                        images/jpg/home-magazine_1x.jpg 500w'
                                                        sizes= '(min-width: 50em) 33vw,
                                                        100vw'
                                                alt='A man' />-->
                                    <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '','(min-width: 50em) 33vw,100vw'); ?>
                                </a>
                            </figure>
                            <section>
                                <h2 class='rubric magazine'><span class='topic'><a href='<?php echo $topicSlug; ?>'><?php echo $topicName; ?></a></span></h2>
                                <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                                <p><?php the_excerpt(); ?></p>
                                <address><?php echo get_post_meta(get_the_ID(), 'authors_select_metabox', true); ?> <?php echo ucfirst(get_post_meta(get_the_ID(), 'authors_name_metabox', true)); ?></address>
                                <time><?php echo $issueName; ?></time>
                            </section>
                        </article>

                        <?php
                    endwhile;
                    wp_reset_query();
                    ?>
                </main>
            </section>
            <!--end aside magazine -->

            <!--start aside dharma talks -->
            <section class='aside-dharmatalks'>
                <header class='rubric_small'>
                    <h1><a href='<?php echo bloginfo('url') . "/" . DHARMATALKS_POST_TYPE; ?>'><span class='icon icon-dept_dharmatalks'></span>Dharma Talks</a></h1>
                    <p>Video teachings and discussions with contemporary Buddhist teachers</p>
                </header>
                <main>
                    <?php
                    $args = array(
                        'posts_per_page' => 1,
                        'orderby' => 'post_date',
                        'order' => 'DESC',
                        'post_type' => DHARMATALKS_POST_TYPE,
                        'post_status' => 'publish',
                        'suppress_filters' => true
                    );

                    $querydharma = new WP_Query($args);
                    query_posts($querydharma);
                    while ($querydharma->have_posts()) : $querydharma->the_post();

                        $topicSet = get_the_terms(get_the_ID(), "topic");
                        $topicName = isset($topicSet[0]) ? $topicSet[0]->name : "";
                        $topicSlug = isset($topicSet[0]) ? $topicSet[0]->slug : "";
                        ?>
                        <article>
                            <figure>
                                <a href='<?php the_permalink(); ?>'>
                                    <div class='icon-video_play' data-grunticon-embed></div>
                                    <!--<img src='images/jpg/home-llama_1x.jpg'
                                            srcset='images/jpg/home-llama_2x.jpg 1000w,
                                                                            images/jpg/home-llama_1x.jpg 500w'
                                             sizes= '(min-width: 50em) 33vw,
                                                                            100vw'
                                            alt='The Film Title' />-->
                                    <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '','(min-width: 50em) 33vw,100vw'); ?>
                                </a>
                            </figure>
                            <section>
                                <h2 class='rubric dharmatalks'><span class='topic'><a href='<?php echo $topicSlug; ?>'><?php echo $topicName; ?></a></span></h2>
                                <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                                <address><?php echo get_post_meta(get_the_ID(), 'filmclub_authors_name_metabox', true); ?></address>
                                <time><?php the_date('M Y'); ?></time>
                            </section>
                        </article>
                        <?php
                    endwhile;
                    wp_reset_query();
                    ?>
                </main>
                <div class='rule-responsive'></div>
            </section>
            <!--end aside dharma talks -->
        </div>

        <div class = 'rule'></div>

        <!--start actions -->
        <div class = 'actions'>
            <div class = 'action'>
                <h2>Subscribe Today</h2>
                <h1>Tricycle is more than a magazine</h1>
                <p>Subscribe for access to video teachings, monthly films, e-books, and our 25-year archive. Plus: discounts on Tricycle online courses and events.</p>
                <a class = 'button' href = '#'>Subscribe</a>
            </div>

            <div class = 'action'>
                <h2>Weekly Newsletter</h2>
                <h1>The latest from Tricycle to your inbox</h1>
                <form id = 'action-enews'>
                    <input class = 'email' id = 'action-email' placeholder = 'Your email here' type = 'email'>

                    <!--enews modal -->
                    <div class = 'action-modal'>
                        <label for = 'action-modal-switch'>
                            <button id = 'action-modal-trigger'>Sign Up</button>
                        </label>
                        <input class = 'modal-state' id = 'action-modal-switch' type = 'checkbox' />
                        <div class = 'modal-fade-screen'>
                            <div class = 'modal-inner'>
                                <div class = 'modal-close' for = 'action-modal-switch'></div>
                                <h1>Weekly Newsletter</h1>
                                <p>The latest from Tricycle to your inbox</p>
                                <form name = 'action-modal-enews'>
                                    <input class = 'email' id = 'action-modal-email' placeholder = 'Your email here' type = 'email'>
                                    <label><input type = 'checkbox' name = 'enews' value = 'enews-tricycle' checked>The Tricycle Newsletter</label>
                                    <label><input type = 'checkbox' name = 'enews' value = 'enews-dailydharma' checked>Daily Dharma</label>
                                    <label><input type = 'checkbox' name = 'enews' value = 'enews-promotions' checked>Learn More</label>
                                    <button class = 'button'>Sign Up</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!--end enews modal -->

                </form>
            </div>

            <div class = 'action'>
                <h2>Donate Now</h2>
                <p>Tricycle is a nonprofit organization that depends on reader support to make ends meet. Help us share Buddhist teachings and practices worldwide by donating now.</p>
                <a class = 'button' href = '#'>Donate</a>
            </div>
        </div>
        <!--end actions -->
    </aside>
</div>
<!--end wrap_outer -->
<?php get_footer();
?>    