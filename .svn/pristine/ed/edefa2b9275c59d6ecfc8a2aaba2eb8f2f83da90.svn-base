<?php
/*
 * This is the detail template file for magazine.
 */
?>
<?php get_header(); ?>
<!-- end header -->

<?php
while (have_posts()) {
    the_post();
    $post_id = get_the_ID();
    setpopularpostviews($post_id);
    $layout = get_post_meta($post_id, LAYOUT_META_KEY, true);

    $post_type = get_post_type($post_id);
    if ($post_type == "post") {
        $post_Name = "Trike Daily";
        $post_Slug = "trikedaily";
    }
    $posttags = get_the_tags();
    $topics = get_topics_by_post_id($post_id);
    $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";

    $gettemplateImage = get_base_hero_template_featured_image($post_id);

    $getbase_hero_image = "";
    $figurecaption = "";
    
    if(isset($gettemplateImage['featured_image_url']) && $gettemplateImage['featured_image_url']!="")
    {   
        $getbase_hero_image = $gettemplateImage['featured_image_url'];
        $figurecaption = $gettemplateImage['caption'];
    }
    else if(isset($gettemplateImage['use_default_featured_image']) && $gettemplateImage['use_default_featured_image']==1)
    {   
        $image_id = get_post_thumbnail_id();
        $image_url = wp_get_attachment_image_src($image_id,'full', true);
        $getbase_hero_image = $image_url[0];
        $figurecaption = get_post($image_id)->post_excerpt;
    }

    if ($layout == "hero") {
        ?>
        <div class='hero'>
            <figure>
                <?php echo get_image_with_srcset(array("post_id"=>get_the_ID(), "image_type"=>"hero_template_image", "source_width"=>array(2000, 1000, 500), "size"=>"image-size-500", "attr_sizes"=>"100vw")); ?>
                <?php //echo srcset_post_base_hero_template($getbase_hero_image, '', '', '100vw'); ?>
                <?php 
                if ($figurecaption != "") 
                { 
                    ?>
                    <figcaption><?php echo $figurecaption; ?></figcaption>
                    <?php 
                } 
                ?>
            </figure>
        </div>

        <!-- start content -->
        <div class='wrap_outer_<?php echo $layout ?>'>
            <main id="wrap" class='wrap_<?php echo $layout ?>'>
                <!-- start article -->
                <article class='article_<?php echo $layout ?> trikedaily'>
                    <header class='article-header_<?php echo $layout ?>'>
                        <h2 class='rubric <?php echo $post_Slug; ?>'>
                            <a href='<?php echo get_permalink(get_page_id_by_slug(TRIKE_DAILY_SLUG)); ?>' class='icon icon-dept_trikedaily'></a>
                            <span class='dept'><a href='<?php echo get_permalink(get_page_id_by_slug(TRIKE_DAILY_SLUG)); ?>'><?php echo $post_Name; ?></a></span>
                            <span class='subdept'><?php get_trikedaily_department($post->ID); ?></span><span class='topic'><?php echo $topic_urls; ?></span>
                        </h2>
                        <h1><?php echo get_the_title(); ?></h1>
                        <?php
                        if (has_excerpt()) 
                        {
                            the_excerpt();
                        }
                        ?>
                        </p>
                        <address><?php echo getAuthorDetail($post_id, 1, 1); ?></address><time><?php echo get_the_date('M d, Y'); ?></time>
                    </header>

                    <!-- start article body -->
                    <main class='article-main_<?php echo $layout; ?>'>
                        <?php get_tool_tip_sharethis(get_the_title(), get_permalink(), get_the_ID()) ?>

                        <section class='article-body'>
                            <?php the_content(); ?>
                        </section>

                        <div class='article-bottom-matter'>
                            <?php if (!empty($posttags)) { ?>
                                <section class='article-tags'>
                                    <ul>
                                        <?php foreach ($posttags as $tag) { ?>
                                            <li><p class='tag'><a href='<?php echo get_tag_link($tag->term_id); ?>'><?php echo $tag->name ?></a></p></li>
                                        <?php } ?>
                                    </ul>
                                </section>
                            <?php } ?>
                            <section class='article-author'>
                                <address><?php echo getAuthorDetail($post_id, 0, 1, 1); ?></address>
                            </section>

                            <?php get_tool_tip_sharethis_wrap(get_the_title(), get_permalink(), get_the_ID()) ?>
                            <?php
                            if (comments_open() || get_comments_number()) :
                                ?>
                                <div class='comments-toggle showcomments'>
                                    <a href='javascript:void(0);' id="commentlink_title">View Comments</a>
                                </div>
                                <?php
                                comments_template();
                            endif;
                            ?>
                        </div>
                    </main>

                    <aside>
                        <script type='text/javascript'>
                                googletag.cmd.push(function() {
                                googletag.defineSlot('/52618277/trike_trikedaily_sidebar_300x250', [300, 250], 'div-gpt-ad-1455073820730-2').addService(googletag.pubads());
                                googletag.pubads().addEventListener('slotRenderEnded', function(event) {
                                    if (event.slot.getSlotElementId() == "div-gpt-ad-1455075672582-2") {
                                        //to check desktop ad 
                                        if((event.isEmpty)==true){
                                        //means there is an ad
                                            jQuery('.ad_square').remove();
                                        }
                                    }
                                });                        
                                googletag.pubads().enableSingleRequest();
                                googletag.pubads().collapseEmptyDivs();
                                googletag.enableServices();
                                });
                        </script>
                        <div class='ad_square'>
                            <div id='div-gpt-ad-1455073820730-2' style='height:250px; width:300px;'>
                                <script type='text/javascript'>
                                googletag.cmd.push(function() { googletag.display('div-gpt-ad-1455073820730-2'); });
                                </script>
                            </div>
                        </div>
                        <?php
                        $myrows = getMostPopular("");

                        if (!empty($myrows) && count($myrows) > 1) {
                            ?>
                            <div class='popular-posts'>
                                <header>
                                    <h1>Most Popular</h1>
                                </header>

                                <main>
                                    <ol>
                                        <?php
                                        $countviews = 0;
                                        foreach ($myrows as $mostpopular) {
                                            if ($countviews == 5) {
                                                break;
                                            }
                                            $postID = $mostpopular->post_id;
                                            $counter = $mostpopular->counter;
                                            $title = get_the_title($postID);
                                            $permalink = get_permalink($postID);
                                            if ($postID == $post_id) {
                                                continue;
                                            }
                                            $countviews++;
                                            ?>

                                            <li><h1><a href=<?php echo $permalink; ?>><?php echo $title; ?></a></h1></li>
                                            <?php 
                                        } //end of foreach
                                        ?>
                                    </ol>
                                </main>
                            </div>
                            <?php 
                        }//end of if
                        ?>
                    </aside>
                </article>
            </main>
            <!-- end article wrap -->

            <aside>
                <!-- start related -->
                <?php
                $relatedposts = getRelatedPosts($post_id);
                if (!empty($relatedposts)) {
                    ?>
                    <div class='related-posts'>
                        <header class='rubric_top'>
                            <h1>Related</h1>
                        </header>
                        <main>
                            <?php
                            foreach ($relatedposts as $relposts) {
                                $post_type = $relposts['postType'];
                                $postValues = get_post_type_object($post_type);
                                $labels = $postValues->labels; //to fetch the menu name
                                $postMenuName = $labels->menu_name;
                                $postTypeLink = get_post_type_archive_link($post_type);
                                if ($post_type == "post") {
                                    $post_type = "trikedaily";
                                    $postMenuName = "Trike Daily";
                                    $postTypeLink = get_permalink(get_page_id_by_slug(TRIKE_DAILY_SLUG));
                                }

                                $topics = get_topics_by_post_id($relposts['postId']);
                                $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                                ?>
                                <article class='<?php echo $post_type ?>'>
                                    <figure>
                                        <a href='<?php echo $relposts['permalink']; ?>'>
                                            <?php if ($post_type == DHARMATALKS_POST_TYPE || $post_type == FILM_CLUB_POST_TYPE || $post_type == FILM_FESTIVAL_POST_TYPE) { ?>
                                                <div class='icon-video_play' data-grunticon-embed></div>
                                            <?php } ?>
                                            <?php echo get_image_with_srcset(array("post_id"=>$relposts['postId'], "image_type"=>"thumbnail", "source_width"=>array(1000, 500), "size"=>"image-size-500", "attr_sizes"=>"(min-width: 37.5em) 33vw, 100vw")); ?>
                                            <?php //echo srcset_post_thumbnail($relposts['postId'], 'image', '', '(min-width: 50em) 33vw,100vw'); ?>
                                        </a>
                                    </figure>
                                    <section>
                                        <h2 class='rubric <?php echo $post_type ?>'><a href='<?php $postTypeLink; ?>' class='icon icon-dept_<?php echo $post_type ?>'></a>
                                            <span class='dept'>
                                                <a href='<?php echo $postTypeLink; ?>'><?php echo $postMenuName; ?></a>
                                                <span class='topic'><?php echo $topic_urls; ?></span>
                                            </span>
                                        </h2>
                                        <h1><a href='<?php echo $relposts['permalink']; ?>'><?php echo $relposts['title']; ?></a></h1>
                                        <address><?php echo getAuthorDetail($relposts['postId'], 1, 0); ?></address>
                                    </section>
                                </article>
                                <?php
                            }
                            ?>
                        </main>
                    </div>
                <?php }
                ?>
                <!-- end related -->
                <div class='rule'></div>
                <?php
            } else {
                ?>
                <!-- start content -->
                <div class='wrap_outer_<?php echo $layout ?>'>
                    <main class='wrap_<?php echo $layout ?>'>
                        <!-- start article -->
                        <article class='article_<?php echo $layout ?> trikedaily'>
                            <header class='article-header_<?php echo $layout ?>'>
                                <h2 class='rubric <?php echo $post_Slug; ?>'>
                                    <a href='<?php echo get_permalink(get_page_id_by_slug(TRIKE_DAILY_SLUG)); ?>' class='icon icon-dept_trikedaily'></a>
                                    <span class='dept'><a href='<?php echo get_permalink(get_page_id_by_slug(TRIKE_DAILY_SLUG)); ?>'><?php echo $post_Name; ?></a></span>
                                    <span class='subdept'><?php get_trikedaily_department($post->ID); ?></span><span class='topic'><?php echo $topic_urls; ?></span>
                                </h2>
                                <h1><?php echo get_the_title(); ?></h1>
                                <?php
                                if (has_excerpt()) {
                                    the_excerpt();
                                }
                                ?>
                                </p>
                                <address><?php echo getAuthorDetail($post_id, 1, 1); ?></address><time><?php echo get_the_date('M d, Y'); ?></time>
                            </header>

                            <!-- start article body -->
                            <main class='article-main_<?php echo $layout; ?>'>
                                <div class='article-image_featured'>
                                    <figure>
                                        <?php echo get_image_with_srcset(array("post_id"=>get_the_ID(), "image_type"=>"base_template_image", "source_width"=>array(2000, 1000, 500), "size"=>"image-size-500", "attr_sizes"=>"(min-width: 60em) 66vw, 100vw")); ?>
                                        <?php //echo srcset_post_base_hero_template($getbase_hero_image, '', '', '(min-width: 60em) 66vw,100vw', 'base'); ?>
                                        <figcaption><?php echo $figurecaption; ?></figcaption>
                                    </figure>
                                </div>                        
                                <?php get_tool_tip_sharethis(get_the_title(), get_permalink(), get_the_ID()) ?>

                                <section class='article-body'>
                                    <?php the_content(); ?>
                                    <?php                                    
                                        $upload_dir = wp_upload_dir();
                                        $uploadDirectory = $upload_dir['baseurl']."/";                                        
                                        $audioOne = get_post_meta(get_the_ID(), "trikdedaily_meta_audio1", true);
                                        if($audioOne!=""){
                                    ?>                                        
                                        <object width="290" height="24" type="application/x-shockwave-flash" name="mp3player_1" style="outline: none" data="<?php echo get_template_directory_uri(); ?>/player.swf" id="mp3player_1">
                                            <param name="wmode" value="opaque">
                                            <param name="menu" value="false">
                                            <param name="flashvars" value="soundFile=<?php echo $uploadDirectory.$audioOne ?>&amp;playerID=mp3player_1">
                                        </object>
                                    <?php } ?>
                                    
                                    <?php
                                        
                                        $audioTwo = get_post_meta(get_the_ID(), "trikdedaily_meta_audio2", true);
                                        if($audioTwo!=""){
                                    ?>
                                    <br/>
                                    <object width="290" height="24" type="application/x-shockwave-flash" name="mp3player_1" style="outline: none" data="<?php echo get_template_directory_uri(); ?>/player.swf" id="mp3player_1">
                                        <param name="wmode" value="opaque">
                                        <param name="menu" value="false">
                                        <param name="flashvars" value="soundFile=<?php echo $uploadDirectory.$audioTwo ?>&amp;playerID=mp3player_1">
                                    </object>
                                    
                                    <?php } ?>
                                    
                                    
                                </section>

                                <div class='article-bottom-matter'>
                                    <?php if (!empty($posttags)) { ?>
                                        <section class='article-tags'>
                                            <ul>
                                                <?php foreach ($posttags as $tag) { ?>
                                                    <li><p class='tag'><a href='<?php echo get_tag_link($tag->term_id); ?>'><?php echo $tag->name ?></a></p></li>
                                                <?php } ?>
                                            </ul>
                                        </section>
                                    <?php } ?>
                                    <section class='article-author'>
                                        <address><?php echo getAuthorDetail($post_id, 0, 1, 1); ?></address>
                                    </section>

                                    <?php get_tool_tip_sharethis_wrap(get_the_title(), get_permalink(), get_the_ID()) ?>
                                    <?php
                                    if (comments_open() || get_comments_number()) :
                                        ?>
                                        <div class='comments-toggle showcomments'>
                                            <a href='javascript:void(0);' id="commentlink_title">View Comments</a>
                                        </div>
                                        <?php
                                        comments_template();
                                    endif;
                                    ?>
                                </div>
                            </main>


                            <aside>
                                <script type='text/javascript'>
                                googletag.cmd.push(function() {
                                    googletag.defineSlot('/52618277/trike_trikedaily_sidebar_300x250', [300, 250], 'div-gpt-ad-1455073820730-2').addService(googletag.pubads());
                                    googletag.pubads().addEventListener('slotRenderEnded', function(event) {
                                        if (event.slot.getSlotElementId() == "div-gpt-ad-1455076539061-1") {
                                            //to check desktop ad 
                                            if((event.isEmpty)==true){
                                            //means there is an ad
                                                jQuery('.ad_square').remove();
                                            }
                                        }
                                    });                        
                                    googletag.pubads().enableSingleRequest();
                                    googletag.pubads().collapseEmptyDivs();
                                    googletag.enableServices();
                                });
                                </script>
                                <div class='ad_square'>
                                    <div id='div-gpt-ad-1455073820730-2' style='height:250px; width:300px;'>
                                        <script type='text/javascript'>
                                        googletag.cmd.push(function() { googletag.display('div-gpt-ad-1455073820730-2'); });
                                        </script>
                                    </div>
                                </div>
                                <?php
                                //$mostpopularpost = getMostViewPosts(FILM_CLUB_POST_TYPE,$postId,5);
                                $myrows = getMostPopular("");

                                if (!empty($myrows) && count($myrows) > 1) {
                                    ?>
                                    <div class='popular-posts'>
                                        <header>
                                            <h1>Most Popular</h1>
                                        </header>

                                        <main>
                                            <ol>

                                                <?php
                                                $countviews = 0;
                                                foreach ($myrows as $mostpopular) {
                                                    if ($countviews == 5) {
                                                        break;
                                                    }
                                                    //pr($mostpopular);
                                                    $postID = $mostpopular->post_id;
                                                    $counter = $mostpopular->counter;
                                                    $title = get_the_title($postID);
                                                    $permalink = get_permalink($postID);
                                                    if ($postID == $post_id) {
                                                        continue;
                                                    }
                                                    $countviews++;
                                                    ?>

                                                    <li><h1><a href=<?php echo $permalink; ?>><?php echo $title; ?></a></h1></li>




                                                <?php } //end of foreach
                                                ?>

                                            </ol>
                                        </main>
                                    </div>

                                <?php }//end of if
                                ?>
                            </aside>
                        </article>
                    </main>
                    <!-- end article wrap -->

                    <aside>
                        <!-- start related -->
                        <?php
                        $relatedposts = getRelatedPosts($post_id);
                        if (!empty($relatedposts)) {
                            ?>
                            <div class='related-posts'>
                                <header class='rubric_top'>
                                    <h1>Related</h1>
                                </header>
                                <main>
                                    <?php
                                    foreach ($relatedposts as $relposts) {
                                        $post_type = $relposts['postType'];
                                        $postValues = get_post_type_object($post_type);
                                        $labels = $postValues->labels; //to fetch the menu name
                                        $postMenuName = $labels->menu_name;
                                        $postTypeLink = get_post_type_archive_link($post_type);
                                        if ($post_type == "post") {
                                            $post_type = "trikedaily";
                                            $postMenuName = "Trike Daily";
                                            $postTypeLink = get_permalink(get_page_id_by_slug(TRIKE_DAILY_SLUG));
                                        }

                                        $topics = get_topics_by_post_id($relposts['postId']);
                                        $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                                        ?>
                                        <article class='<?php echo $post_type ?>'>
                                            <figure>
                                                <a href='<?php echo $relposts['permalink']; ?>'>
                                                    <?php if ($post_type == DHARMATALKS_POST_TYPE || $post_type == FILM_CLUB_POST_TYPE || $post_type == FILM_FESTIVAL_POST_TYPE) { ?>
                                                        <div class='icon-video_play' data-grunticon-embed></div>
                                                    <?php } ?>

                                                    <?php echo get_image_with_srcset(array("post_id"=>$relposts['postId'], "image_type"=>"thumbnail", "source_width"=>array(1000, 500), "size"=>"image-size-500", "attr_sizes"=>"(min-width: 37.5em) 33vw, 100vw")); ?>
                                                    <?php //echo get_image_with_srcset(array("post_id"=>$relposts['postId'], "image_type"=>"thumbnail", "source_width"=>array(1000, 500), "size"=>"image-size-500", "attr_sizes"=>"(min-width: 37.5em) 33vw, 100vw")); ?>
                                                    <?php //echo srcset_post_thumbnail($relposts['postId'], 'image', '', '(min-width: 50em) 33vw,100vw'); ?>
                                                </a>
                                            </figure>
                                            <section>
                                                <h2 class='rubric <?php echo $post_type ?>'><a href='<?php $postTypeLink; ?>' class='icon icon-dept_<?php echo $post_type ?>'></a>
                                                    <span class='dept'>
                                                        <a href='<?php echo $postTypeLink; ?>'><?php echo $postMenuName; ?></a>
                                                        <span class='topic'><?php echo $topic_urls; ?></span>
                                                    </span>
                                                </h2>
                                                <h1><a href='<?php echo $relposts['permalink']; ?>'><?php echo $relposts['title']; ?></a></h1>
                                                <address><?php echo getAuthorDetail($relposts['postId'], 1, 0); ?></address>
                                            </section>
                                        </article>
                                        <?php
                                    }
                                    ?>
                                </main>
                            </div>
                        <?php }
                        ?>
                        <!-- end related -->
                        <div class='rule'></div>
                        <?php
                    }
                }
                ?>
                    <script type="text/javascript">
                        var no_comment = <?php echo get_comments_number($post_id); ?>;
                        jQuery(function(){
                            if(no_comment == 0)
                            {
                                jQuery("#disqus_thread").css("height", "420px");
                            }
                        });            
                    </script>
                <!-- start footer -->
                <?php get_footer(); ?>