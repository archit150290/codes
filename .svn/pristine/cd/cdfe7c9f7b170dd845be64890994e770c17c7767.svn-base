<?php get_header(); ?>
<?php

$postId = get_the_ID();
$topics = get_topics_by_post_id($postId);
$topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
$objPost = get_post($postId);

/* call setPostView() function for increasing view counter of the post */
setPostViews($postId);
setpopularpostviews($postId);
?>
<!-- start content -->
<div class='wrap_outer_base'>
    <main class='wrap_base'>
        <!-- start article -->
	<article class='article_base filmclub'>
            <?php
            // Start the loop.
            while ( have_posts() ) : the_post();
                ?>
                <header class='article-header_video'>
                    <h2 class='rubric filmclub'>
                        <a href='<?php echo get_post_type_archive_link(FILM_CLUB_POST_TYPE); ?>' class='icon icon-dept_filmclub'></a>
                        <span class='dept'><a href='<?php echo get_post_type_archive_link(FILM_CLUB_POST_TYPE); ?>'>Film Club</a></span>
                        <span class='topic'><?php echo $topic_urls; ?></span>
                    </h2>
                    <time><?php echo get_the_date('M d, Y'); ?></time>
                    <h1><?php the_title(); ?></h1>
                </header>

                <!-- start article body -->
                <main class='article-main_film'>
                    <?php
                    $IslatestPost =  is_latest_post($postId,'',FILM_CLUB_POST_TYPE);
                    if($IslatestPost){
                            $video_data = get_post_meta($postId ,'meta_type_filmclub_video',true);
                    }else{
                            $video_data = get_post_meta($postId ,'meta_type_filmclub_shorttrailer',true);	
                    }

                    if(is_post_behind_paywall(get_the_ID()))
                    {
                        if($paywall_login)
                        { 
                            ?>
                            <div class='article-video_featured filmclub'>
                                <figure>
                                    <div class='icon-video_play' rel="<?php echo $video_data; ?>" data-grunticon-embed></div>
                                    <?php echo get_image_with_srcset(array("post_id"=>get_the_ID(), "image_type"=>"thumbnail", "source_width"=>array(2000, 1000, 500), "size"=>"image-size-500", "attr_sizes"=>"(min-width: 50em) 75vw, 100vw")); ?>
                                    <div class='video-wrapper'></div>
                                </figure>
                            </div>
                            <?php
                        }
                        else
                        {
                            ?>																				
                            <div class='article-video_paywall filmclub'>
                                <figure>
                                    <div class='icon-video_play' data-grunticon-embed></div>
                                    <?php echo get_image_with_srcset(array("post_id"=>get_the_ID(), "image_type"=>"thumbnail", "source_width"=>array(2000, 1000, 500), "size"=>"image-size-500", "attr_sizes"=>"(min-width: 50em) 75vw, 100vw")); ?>
                                    <div class='video-wrapper'></div>
                                </figure>
                            </div>
                            <?php
                            echo getpaywall_popup('filmclub','TK film club paywall copy!');
                        }
                    }
                    else
                    { 
                        ?>
                        <div class='article-video_featured filmclub'>
                            <figure>
                                <div class='icon-video_play' rel="<?php echo $video_data; ?>" data-grunticon-embed></div>
                                <?php echo get_image_with_srcset(array("post_id"=>get_the_ID(), "image_type"=>"thumbnail", "source_width"=>array(2000, 1000, 500), "size"=>"image-size-500", "attr_sizes"=>"(min-width: 50em) 75vw, 100vw")); ?>
                                <div class='video-wrapper'></div>
                            </figure>
                        </div>
                        <?php
                    }
                    ?>

                    <?php get_tool_tip_sharethis(get_the_title(), get_permalink(), get_the_ID()); ?>
                    <input type="hidden" id="latestpostfc" value="<?php echo $IslatestPost?>">
                    <section class='article-body'>
                        <p>
                            <?php	
                            $byline = get_post_meta($postId, 'authors_name_metabox', true);
                            $film_year = get_post_meta(get_the_ID(), FILMCLUB_YEAR_METABOX, true);
                            $country =  get_post_meta(get_the_ID() ,'country_meta_key',true);
                            if($byline){
                                echo strip_tags(getAuthorDetail(get_the_ID(),1,0))."<br>";
                            }else{
                                echo "Director: ".strip_tags(getAuthorDetail(get_the_ID(),0,0))."<br />";
                            }
                            if($country){
                                echo "Country: ".$country."<br />";
                            }
                            if($film_year){
                                echo "Year: ".$film_year;
                            }
                            ?>
                        </p>    
                        <?php 
                        $posttrailer = get_post_meta(get_the_ID(), 'meta_type_filmclub_shorttrailer', true); ?>
                        <?php if(!empty($posttrailer)) { ?>
                                <p><a class='view-trailer' href='javascript:void(0);'>View Trailer</a></p>
                        <?php } ?>
                        <?php the_content(); ?>

                        <?php
                        if(is_post_behind_paywall(get_the_ID()) && !$paywall_login)
                        {
                            get_paywall_login('filmclub','TK film club paywall copy!'); 
                        }
                        ?> 
                    </section>

                    <!-- start video modal -->
                    <div class='video-modal'>
                       <input class='modal-state' id='video-modal-switch' type='checkbox'/>
                       <div class='modal-fade-screen'>
                           <div class='modal-inner_video'>
                               <div class='modal-close' for='video-modal-switch'></div>
                               <div class="video">
                                   <div class="video-wrapper">
                                        <?php echo $trailerVideo = get_post_meta(get_the_ID(), 'meta_type_filmclub_shorttrailer', true); ?>
                                           <?php if(!empty($trailerVideo))
                                            {
                                            ?>
                                                    <iframe src="<?php echo get_post_meta(get_the_ID(), 'meta_type_filmclub_shorttrailer', true); ?>?autoplay=0&title=0&byline=0&portrait=0" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
                                           <?php
                                            }
                                            else
                                            {
                                            ?>    
                                                    <iframe src="Empty" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
                                           <?php
                                            }
                                           ?>
                                   </div>
                               </div>
                           </div>
                       </div>
                    </div>
                    <!-- end video modal -->

                    <div class='article-bottom-matter'>
                        <?php 
                        $tags_array = wp_get_post_tags(get_the_ID());

                        if(!empty($tags_array)){
                            ?> 
                            <section class='article-tags'>
                                <ul>
                                    <?php foreach($tags_array as $tags){ ?>
                                        <li><p class='tag'><a href='<?php echo get_tag_link($tags->term_id); ?>'><?php echo ucfirst($tags->name); ?></a></p></li>
                                    <?php } ?>
                                </ul>
                            </section>
                            <?php 
                        } 
                        ?>

                        <?php get_tool_tip_sharethis_wrap(get_the_title(), get_permalink(), get_the_ID()) ?>

                        <?php
                        if ( comments_open() || get_comments_number() ) :
                            ?>
                            <div class='comments-toggle showcomments'>
                                <a href='javascript:void(0);' id="commentlink_title">View Comments</a>
                            </div>
                            <?php
                            comments_template();
                        endif;
                        ?>
                    </div>
                </main>
                <script type="text/javascript">
                    var no_comment = <?php echo get_comments_number($postId); ?>;
                    jQuery(function(){
                        if(no_comment == 0)
                        {
                            jQuery("#disqus_thread").css("height", "420px");
                        }
                    });            
                </script>
                <?php
                // End the loop.
            endwhile;
            ?>
            <aside>
                <script type='text/javascript'>
                    googletag.cmd.push(function() {
                        googletag.defineSlot('/52618277/trike_filmclub_sidebar_300x250', [300, 250], 'div-gpt-ad-1455075672582-2').addService(googletag.pubads());
                            googletag.pubads().addEventListener('slotRenderEnded', function(event) {
                                if (event.slot.getSlotElementId() == "div-gpt-ad-1455075672582-2") {
                                    //to check desktop ad 
                                    if((event.isEmpty)==true){
                                    //means there is an ad
                                        jQuery('.ad_square').remove();
                                    }
                                }
                            });
                        googletag.pubads().enableSingleRequest();
                        googletag.pubads().collapseEmptyDivs();
                        googletag.enableServices();
                    });
                </script>
                <div class='ad_square'>
                    <div id='div-gpt-ad-1455075672582-2' style='height:250px; width:300px;'>
                        <script type='text/javascript'>
                            googletag.cmd.push(function() { googletag.display('div-gpt-ad-1455075672582-2'); });
                        </script>
                    </div>
                </div>
                <?php
                $myrows = getMostPopular("");
                                                        
                if(!empty($myrows) && count($myrows) > 1){
                    ?>
                    <div class='popular-posts'>
                        <header>
                                <h1>Most Popular</h1>
                        </header>
                        <main>
                            <ol>
                                <?php 
                                $countviews = 0;
                                foreach($myrows as $mostpopular)
                                {
                                    if($countviews == 5)
                                    {
                                        break;
                                    }
                                    $postID = $mostpopular->post_id;
                                    $counter = $mostpopular->counter;
                                    $title = get_the_title($postID);
                                    $permalink = get_permalink($postID);
                                    if($postID == $postId)
                                    {
                                        continue;
                                    }
                                    $countviews++;
                                    ?>
                                    <li><h1><a href=<?php echo $permalink; ?>><?php echo $title; ?></a></h1></li>
                                    <?php 
                                } //end of foreach
                                ?>
                            </ol>
                        </main>
                    </div>
                    <?php 
                }//end of if
                ?>
            </aside>
        </article>
        <!-- end article wrap -->
    </main>
    <aside>
        <!-- start related -->
        <?php
        $relatedposts = getRelatedPosts($postId);
        if(!empty($relatedposts)){
            ?>
            <div class='related-posts'>
                <header class='rubric_top'>
                    <h1>Related</h1>
                </header>
		<main>
                    <?php 
                    foreach($relatedposts as $relposts){
                        $post_type = $relposts['postType'];
                        $postValues = get_post_type_object($post_type);
                        $labels = $postValues->labels; //to fetch the menu name
                        $postMenuName = $labels->menu_name;
                        $post_link = get_post_type_archive_link($post_type);

                        if ($post_type == "post") {
                            $post_type = "trikedaily";
                            $postMenuName = "Trike Daily";
                            $post_link = get_permalink(get_page_id_by_slug(TRIKE_DAILY_SLUG));
                        }

                        $topics = get_topics_by_post_id($relposts['postId']);
                        $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";    
                        ?>
                        <article class='<?php echo $post_type ?>'>
                            <figure>
                                <a href='<?php echo $relposts['permalink']; ?>'>
                                    <?php if ($post_type == DHARMATALKS_POST_TYPE || $post_type == FILM_CLUB_POST_TYPE || $post_type == FILM_FESTIVAL_POST_TYPE ) { ?>
                                            <div class='icon-video_play' data-grunticon-embed></div>
                                    <?php } ?>	
                                    <?php echo get_image_with_srcset(array("post_id"=>$relposts['postId'], "image_type"=>"thumbnail", "source_width"=>array(1000, 500), "size"=>"image-size-500", "attr_sizes"=>"(min-width: 37.5em) 33vw, 100vw")); ?>
                                </a>
                            </figure>
                            <section>
                                <h2 class='rubric <?php echo $post_type ?>'>
                                    <a href='<?php echo $post_link; ?>' class='icon icon-dept_<?php echo $post_type ?>'></a>
                                    <span class='dept'><a href='<?php echo $post_link; ?>'><?php echo ucfirst($postMenuName); ?></a>
                                    <span class='topic'><?php echo $topic_urls; ?></span>
                                    </span>
                                </h2>
                                <h1><a href='<?php echo $relposts['permalink']; ?>'><?php echo $relposts['title']; ?></a></h1>
                                <address><?php echo getAuthorDetail($relposts['postId'],1,0); ?></address>
                            </section>
                        </article>
                        <?php 
                    } 
                    ?>
                </main>
            </div>
            <?php 
        } 
        ?>
	<!-- end related -->
        <div class='rule'></div>
        <?php get_footer(); ?>                