<?php
$post_id = get_the_ID();
$layout = get_post_meta($post_id, LAYOUT_META_KEY, true);
$post = get_post();
$post_type = $post->post_type; //defines the post type
$topics = get_the_terms($post_id, 'topic', true);
$posttags = get_the_tags();
setPostViews($post_id);
$dek = get_post_meta($post_id, DEK_META_KEY, true);

$subdepartment = get_the_terms($post->ID, "subdepartment");
$subdepartmentName = isset($subdepartment[0]) ? $subdepartment[0]->name : "";
$subdepartmentslug = isset($subdepartment[0]) ? $subdepartment[0]->slug : "";
$figurecaption=get_post_meta(get_the_ID(),FIGCAPTION_META_KEY,true);
?>
<?php get_header(); ?>
<!-- end header -->

<?php
//for hero
if ($layout == "hero") {
    ?>
    <div class='hero'>
        <figure>
            <?php echo srcset_post_thumbnail($post_id, 'image', '','100vw'); ?>
            <figcaption><?php echo $figurecaption; ?></figcaption>
        </figure>
    </div>   

<?php }
?>

<!-- start content -->
<div class='wrap_outer_<?php echo $layout ?>'>
    <main class='wrap_<?php echo $layout ?>'>

        <!-- start article -->
        <article class='article_<?php echo $layout ?> trikedaily'>
            <header class='article-header_<?php echo $layout ?>'>
                <h2 class='rubric <?php echo $post_type; ?>'>
                    <a href='#' class='icon icon-dept_<?php echo $post_type ?>'></a>
                    <span class='dept'><a href='#'><?php echo $post_type; ?></a></span><span class='subdept'><a href='#'>Sub Department</a></span><span class='topic'><a href='<?php getTopicUrl($topics[0]->slug); ?>'><?php echo $topics[0]->name; ?></a></span>
                </h2>
                <h1><?php echo get_the_title(); ?></h1>
                <p><?php the_excerpt(); ?></p>
                <address><a href=''><?php echo getAuthorDetail(get_the_ID(),1,0); ?> </a></address><time><?php echo get_the_date('M d, Y'); ?></time>
            </header>

            <!-- start article body -->
            <main class='article-main_<?php echo $layout; ?>'>
                <?php if ($layout == "base") { ?>
                    <div class='article-image_featured'>
                        <figure>
                            <?php echo srcset_post_thumbnail($post_id, 'image', '','(min-width: 60em) 66vw,100vw'); ?>
                            <figcaption><?php echo $figurecaption; ?></figcaption>
                        </figure>
                    </div>
                <?php } ?>
                <div class='tools_top'>
                    <ul>
                        <li><a class='icon icon-tools_facebook' href='#' data-grunticon-embed></a></li>
                        <li><a class='icon icon-tools_twitter' href='#' data-grunticon-embed></a></li>
                        <li><a class='icon icon-tools_email' href='#' data-grunticon-embed></a></li>
                        <li><a class='icon icon-tools_print' href='#' data-grunticon-embed></a></li>
                    </ul>
                </div>

                <section class='article-body'>
                    <?php echo $post->post_content; ?>
                </section>

                <div class='article-bottom-matter'>
                    <section class='article-tags'>
                        <ul>
                            <?php
                            if ($posttags) {
                                foreach ($posttags as $tag) {
                                    ?>
                                    <li><p class='tag'><a href='<?php echo get_tag_link($posttags[0]->term_id); ?>'><?php echo $tag->name ?></a></p></li>
                                    <?php
                                }
                            }
                            ?>

                        </ul>
                    </section>

                    <section class='article-author'>
                        <address><span class='author-name'><a href=''>Carl Sagan</a></span> made in the interiors of collapsing stars, trillion, rogue, with pretty stories for which there's little good evidence.</address>
                    </section>

                    <div class='tools-wrap_bottom'>
                        <ul class='tools'>
                            <li><a class='icon icon-tools_facebook' href='#' data-grunticon-embed></a></li>
                            <li><a class='icon icon-tools_twitter' href='#' data-grunticon-embed></a></li>
                            <li><a class='icon icon-tools_email' href='#' data-grunticon-embed></a></li>
                            <li><a class='icon icon-tools_print' href='#' data-grunticon-embed></a></li>
                        </ul>
                    </div>

                    <div class='comments-toggle'>
                        <a href='#'>View Comments</a>
                    </div>
                </div>

            </main>

            <aside>
                <div class='ad_square'>
                    <img src='<?php echo get_template_directory_uri(); ?>/images/jpg/ad-shinyocenter'>
                </div>
                <?php
                $mostpopularpost = getMostViewPosts(ARTICLE_POST_TYPE, $post_id, 5);
                if (!empty($mostpopularpost)) {
                    ?>
                    <div class='popular-posts'>
                        <header>
                            <h1>Most Popular</h1>
                        </header>
                        <main>
                            <ol>
                                <?php
                                $viewedposts = "";
                                foreach ($mostpopularpost as $mostpopular) {
                                    $viewedposts .= '<li><h1><a href="' . $mostpopular["permalink"] . '">' . $mostpopular["title"] . '</a></h1></li>';
                                }
                                echo $viewedposts;
                                ?>
                            </ol>
                        </main>
                    </div>
                <?php } ?>
            </aside>

        </article>

    </main>
    <!-- end article wrap -->

    <aside>
        <!-- start related -->
        <?php
        $relatedposts = getRelatedPosts($post_id);
        if (!empty($relatedposts)) {
            ?>

            <div class='related-posts'>
                <header class='rubric_top'>
                    <h1>Related</h1>
                </header>

                <main>
                    <?php
                    foreach ($relatedposts as $relposts) {

                        $post_type = $relposts['postType'];

                        if ($post_type == "post") {
                            $post_type = "trikedaily";
                            $post_link = "blog";
                        } else if ($post_type == "dharma-talks") {
                            $post_type = "dharmatalks";
                            $post_link = "dharma-talks";
                        } else if ($post_type == "film-club") {
                            $post_type = "filmclub";
                            $post_link = "film-club";
                        }else if ($post_type == "film-festival") {
                            $post_type = "filmfestival";
                            $post_link = "film-fetival";
                        } else {
                            $post_type;
                            $post_link = $post_type;
                        }
                        ?>

                        <article class='<?php echo $post_type ?>'>
                            <figure>
                                <a href='<?php echo $relposts['permalink']; ?>'>
                                    <?php if ($post_type == 'dharmatalks' || $post_type == 'filmclub') { ?>
                                        <div class='icon-video_play' data-grunticon-embed></div>
                                    <?php } ?>

                                    <?php echo srcset_post_thumbnail($relposts['postId'], 'image', '','(min-width: 50em) 33vw,100vw'); ?>
                                </a>
                            </figure>
                            <section>
                                <h2 class='rubric <?php echo $post_type ?>'><a href='<?php echo bloginfo('url')."/".$post_link ?>' class='icon icon-dept_<?php echo $post_type ?>'></a>
                                    <span class='dept'>
                                        <a href='<?php echo bloginfo('url')."/".$post_link ?>'><?php echo ucfirst($post_type); ?></a>
                                            <span class='topic'><a href='<?php getTopicUrl($relposts['topicSlug']); ?>'><?php echo $relposts['topicName']; ?></a></span>
                                    </span>
                                </h2>
                                <h1><a href='<?php echo $relposts['permalink']; ?>'><?php echo $relposts['title']; ?></a></h1>
                                <address><?php echo $relposts['author_by_director']; ?>&nbsp;<?php echo $relposts['author']; ?></address>
                            </section>
                        </article>


                    <?php } ?>
                </main>
            </div>
        <?php } ?>
        <!-- end related -->

        <div class='rule'></div>

        <!-- start actions -->
        <div class='actions'>
            <div class='action'>
                <h2>Subscribe Today</h2>
                <h1>Tricycle is more than a magazine</h1>
                <p>Subscribe for access to video teachings, monthly films, e-books, and our 25-year archive. Plus: discounts on Tricycle online courses and events.</p>
                <a class='button' href='#'>Subscribe</a>
            </div>

            <div class='action'>
                <h2>Weekly Newsletter</h2>
                <h1>The latest from Tricycle to your inbox</h1>
                <form id='action-enews'>
                    <input class='email' id='action-email' placeholder='Your email here' type='email'>

                    <!-- enews modal -->
                    <div class='action-modal'>
                        <label for='action-modal-switch'>
                            <button id='action-modal-trigger'>Sign Up</button>
                        </label>
                        <input class='modal-state' id='action-modal-switch' type='checkbox' />
                        <div class='modal-fade-screen'>
                            <div class='modal-inner'>
                                <div class='modal-close' for='action-modal-switch'></div>
                                <h1>Weekly Newsletter</h1>
                                <p>The latest from Tricycle to your inbox</p>
                                <form name='action-modal-enews'>
                                    <input class='email' id='action-modal-email' placeholder='Your email here' type='email'>
                                    <label><input type='checkbox' name='enews' value='enews-tricycle' checked>The Tricycle Newsletter</label>
                                    <label><input type='checkbox' name='enews' value='enews-dailydharma' checked>Daily Dharma</label>
                                    <label><input type='checkbox' name='enews' value='enews-promotions' checked>Learn More</label>
                                    <button class='button'>Sign Up</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- end enews modal -->

                </form>
            </div>

            <div class='action'>
                <h2>Donate Now</h2>
                <p>Tricycle is a nonprofit organization that depends on reader support to make ends meet. Help us share Buddhist teachings and practices worldwide by donating now.</p>
                <a class='button' href='#'>Donate</a>
            </div>
        </div>
        <!-- end actions -->
    </aside>
</div>
<!-- end wrap_outer -->

<!-- start footer -->
<?php get_footer(); ?>
