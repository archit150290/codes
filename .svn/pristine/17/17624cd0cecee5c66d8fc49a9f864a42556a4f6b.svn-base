<?php
//the below code is used to register post type ebooks
define("EBOOKS_POST_TYPE", "ebooks");

function custom_post_type_ebooks() {
    $labels = array(
        'name' => _x('E-Book', 'post type general name', 'your-plugin-textdomain'),
        'singular_name' => _x('E-Books', 'post type singular name', 'your-plugin-textdomain'),
        'menu_name' => _x('E-Books', 'admin menu', 'your-plugin-textdomain'),
        'name_admin_bar' => _x('E-Books', 'add new on admin bar', 'your-plugin-textdomain'),
        'add_new' => _x('Add New', 'ebooks', 'your-plugin-textdomain'),
        'add_new_item' => __('Add New Ebook', 'your-plugin-textdomain'),
        'new_item' => __('New Ebook', 'your-plugin-textdomain'),
        'edit_item' => __('Edit Ebook', 'your-plugin-textdomain'),
        'view_item' => __('View Ebook', 'your-plugin-textdomain'),
        'all_items' => __('All E-Books', 'your-plugin-textdomain'),
        'search_items' => __('Search Ebooks', 'your-plugin-textdomain'),
        'parent_item_colon' => __('Parent Ebooks:', 'your-plugin-textdomain'),
        'not_found' => __('No Ebooks found.', 'your-plugin-textdomain'),
        'not_found_in_trash' => __('No Ebooks found in Trash.', 'your-plugin-textdomain')
    );

    $args = array(
        'labels' => $labels,
        'public' => true,
        'publicly_queryable' => true,
        'show_ui' => true,
        'show_in_menu' => true,
        'rewrite' => array('slug' => EBOOKS_POST_TYPE, 'with_front' => false),
        'capability_type' => 'post',
        'has_archive' => true,
        'hierarchical' => false,
        'menu_position' => null,
        'supports' => array('title', 'editor', 'author', 'thumbnail'),
        'taxonomies' => array('post_tag'),
            //'register_meta_box_cb' => 'add_ebooks_meta_boxes'
    );
    register_post_type(EBOOKS_POST_TYPE, $args);
}

add_action('init', 'custom_post_type_ebooks');


add_action('add_meta_boxes', 'add_ebooks_meta_boxes');

function add_ebooks_meta_boxes() {
    add_meta_box('ebooks_meta_box_id', 'ebooks', 'add_ebooks_metabox_cb', EBOOKS_POST_TYPE, 'normal', 'default');
}

function add_ebooks_metabox_cb($post) {

    wp_nonce_field(plugin_basename(__FILE__), 'wp_custom_attachment_nonce');

    $html = '<p class="description">';
    $html .= 'Upload your PDF here. *Please Upload file less than 2MB';
    $html .= '</p>';
    $html .= '<input type="file" id="meta_keyebook_file" name="meta_keyebook_file" onblur="return checkfilesize()" value="" size="25" />';
    echo $html . "<br>";
    ?>
    <script>
        function checkfilesize()
        {

            var myFile = document.getElementById('meta_keyebook_file');
            myFile.addEventListener('change', function () {
                var size = this.files[0].size / 1048576;
                if (size < 2)
                {
                    return true;
                }

                else
                    alert("size is greater than 2 mb, please Upload less than that.")
                document.getElementById('meta_keyebook_file').value = "";
            
    });
        }
    </script>
    <?php
    $authorsaved = get_post_meta($post->ID, 'meta_keyebook_file', true);
    if (!empty($authorsaved)) {
        echo "<b>Already Uploaded File: </b>" . basename($authorsaved['file']);
        ?>
        <input type="hidden" name="urlinfo" value="<?php echo $authorsaved['file']; ?>">
        <button type="submit" name="delete" onclick="return confirm('Are you sure you want to delete this item?');">Delete</button>

        <?php
    } else {
        echo "<b>No Ebook Selected Yet</b>";
    }
}

function save_custom_meta_data($post_id) {
    // Check if our nonce is set.

    if (!isset($_POST['wp_custom_attachment_nonce'])) {
        return $post_id;
    }
    /* --- security verification --- */
    if (!wp_verify_nonce($_POST['wp_custom_attachment_nonce'], plugin_basename(__FILE__))) {
        return $post_id;
    } // end if

    if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
        return $post_id;
    } // end if

    if ('page' == $_POST['post_type']) {
        if (!current_user_can('edit_page', $post_id)) {
            return $post_id;
        } // end if
    } else {
        if (!current_user_can('edit_page', $post_id)) {
            return $post_id;
        } // end if
    } // end if
    /* - end security verification - */

    if (!empty($_FILES['meta_keyebook_file']['name'])) {

        $supported_types = array('application/pdf');

        // Get the file type of the upload
        $arr_file_type = wp_check_filetype(basename($_FILES['meta_keyebook_file']['name']));
        $uploaded_type = $arr_file_type['type'];

        // Check if the type is supported. If not, throw an error.
        if (in_array($uploaded_type, $supported_types)) {

            // Use the WordPress API to upload the file
            $upload = wp_upload_bits($_FILES['meta_keyebook_file']['name'], null, file_get_contents($_FILES['meta_keyebook_file']['tmp_name']));


            if (isset($upload['error']) && $upload['error'] != 0) {
                wp_die('There was an error uploading your file. The error is: ' . $upload['error']);
            }

            update_post_meta($post_id, 'meta_keyebook_file', $upload);
            // end if/else
        } else {
            wp_die("The file type that you've uploaded is not a PDF.");
        } // end if/else
    } else if (isset($_REQUEST["delete"])) {
        $upload1 = "";
        unlink($_REQUEST['urlinfo']);
        update_post_meta($post_id, 'meta_keyebook_file', $upload1);
    }
}

// end save_custom_meta_data
add_action('save_post', 'save_custom_meta_data');

function update_edit_form() {
    echo ' enctype="multipart/form-data"';
}

// end update_edit_form
add_action('post_edit_form_tag', 'update_edit_form');

