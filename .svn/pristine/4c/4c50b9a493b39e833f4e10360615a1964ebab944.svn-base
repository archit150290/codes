<?php get_header(); ?>
<?php
$tax = $wp_query->get_queried_object();
$tax_name = $tax->name;
//applying query
$args = array(
    'post_type' => array('post', EBOOKS_POST_TYPE, MAGAZINE_POST_TYPE, FILM_CLUB_POST_TYPE, DHARMATALKS_POST_TYPE),
    'tax_query' => array(
        'relation' => 'AND',
        array(
            'taxonomy' => 'department',
            'field' => 'slug',
            'terms' => $tax_name,
            'operator' => 'IN',
        ),
    ),
    'post_status' => 'publish',
    'order' => 'DESC',
    'orderby' => 'date',
    'posts_per_page' => 3,
);
$eq_query = new WP_Query($args);
?>
<!-- start content -->
<div class='wrap'>
    <!-- start landing marquee -->
    <div class='landing-marquee'>
        <header class='rubric_top'>
            <h1><?php echo $tax_name; ?></h1>
        </header>

        <main class='landing-marquee-articles'>

            <?php
            while ($eq_query->have_posts()): $eq_query->the_post();
                $post_type = get_post_type();
                
                /*if ($post_type == "post") {
                    $post_type = "trikedaily";
                    $post_link = "blog";
                } else if ($post_type == "dharma-talks") {
                    $post_type = "dharmatalks";
                    $post_link = "dharma-talks";
                } else if ($post_type == "film-club") {
                    $post_type = "filmclub";
                    $post_link = "film-club";
                } else if ($post_type == "film-festival") {
                    $post_type = "filmfestival";
                    $post_link = "film-festival";
                } else {
                    $post_type;
                    $post_link = $post_type;
                }
                */
                
                $postValues = get_post_type_object($post_type);
                $labels = $postValues->labels; //to fetch the menu name
                $postMenuName = $labels->menu_name;
                $post_link = get_post_type_archive_link($post_type);
                
                if ($post_type == "post") {
                    $post_type = "trikedaily";
                    $postMenuName = "Trike Daily";
                    $post_link = get_permalink(get_page_id_by_slug(TRIKE_DAILY_SLUG));
                }
                
                $postId[] = $eq_query->post->ID;
                $byline = get_post_meta($post->ID, 'authors_select_metabox', true);
                $byauthor = get_post_meta($post->ID, 'authors_name_metabox', true);
                
                $topics = get_topics_by_post_id(get_the_ID());
                $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                ?>
                <article class = '<?php echo $post_type; ?>' >
                    <figure>
                        <a href = '<?php the_permalink(); ?>'>
                            <?php if ($post_type == DHARMATALKS_POST_TYPE || $post_type == FILM_CLUB_POST_TYPE || $post_type == FILM_FESTIVAL_POST_TYPE ) {
                                echo "<div class='icon-video_play' data-grunticon-embed></div>";
                            } ?>
                            <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 50em) 33vw,100vw'); ?>
                        </a>
                    </figure>
                    <section class='rubric <?php echo $post_type; ?>'>
                        <a class='icon icon-dept_<?php echo $post_type; ?>' href = '<?php echo $post_link; ?>'></a>
                        <h2 class='<?php echo $post_type; ?>'><a href = '<?php echo $post_link; ?>'><?php echo $postMenuName; ?></a>
                        <span class='topic'><?php echo $topicName; ?></span></h2>
                    </section>
                    <section class = 'titles'>
                        <h1><a href=<?php the_permalink();?>><?php the_title(); ?></a></h1>
                        <p><?php
                            if ($post_type != 'dharmatalks') {
                                if ($post_type == "filmclub") {
                                    echo "";
                                } else {
                                    the_excerpt();
                                }
                            }
                            ?></p>
                        <address><?php echo getAuthorDetail(get_the_ID(),1,0); ?></address>
                        <time><?php echo get_the_date('M d, Y'); ?></time>
                    </section>
                </article>

                <?php
            endwhile;
            wp_reset_query();
            ?> 
        </main>
    </div>
    <!-- end landing marquee -->

    <!-- start landing stack -->
    <div class='landing-stack'>

        <?php
        if (!empty($postId[0])) {
            $args = array(
                'post_type' => array('post'),
                'tax_query' => array(
                    'relation' => 'AND',
                    array(
                        'taxonomy' => 'department',
                        'field' => 'slug',
                        'terms' => $tax_name,
                        'operator' => 'IN',
                    ),
                ),
                'post_status' => 'publish',
                'post__not_in' => $postId,
                'order' => 'DESC',
                'orderby' => 'date',
                'posts_per_page' => 12,
            );
            $eq_query = new WP_Query($args);
            $count = 0;

            while ($eq_query->have_posts()): $eq_query->the_post();

                $topics = get_topics_by_post_id(get_the_ID());
                $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
//                echo $count;
                if ($count == "3") {
                    ?>
                    <div class = 'CTA-module'>
                        <div class = 'rule'></div>
                        <div class = 'CTA-ad' style = '
                             background-color: #ddd;
                             line-height: 1; padding: 2em;
                             margin: 0 auto;
                             width: 75%;
                             height: 10em;
                             text-align: center;
                             '>
                            <p>Call-to-Action Module. Can be set in the CMS to any of the following: (1) Ad served via Google DFP Small Business (TBD), (2) Daily Dharma, (3) Subscribe CTA, (4) Newletter CTA</p>
                        </div>
                        <div class = 'rule'></div>
                    </div>
                    <?php
                }
                $postValues = get_post_type_object($post_type);
                $labels = $postValues->labels; //to fetch the menu name
                $postMenuName = $labels->menu_name;
                $postTypeLink = get_post_type_archive_link($post_type);
                $post_link = get_post_type_archive_link($post_type);
                
                if ($post_type == "post") {
                    $post_type = "trikedaily";
                    $postMenuName = "Trike Daily";
                    $post_link = get_permalink(get_page_id_by_slug(TRIKE_DAILY_SLUG));
                }

                $byline = get_post_meta($post->ID, 'authors_select_metabox', true);
                $byauthor = get_post_meta($post->ID, 'authors_name_metabox', true);
                ?>
                <article class='<?php echo $post_type; ?>'>
                    <figure>
                        <a href='<?php the_permalink(); ?>'>
                            <?php if ($post_type == DHARMATALKS_POST_TYPE || $post_type == FILM_CLUB_POST_TYPE || $post_type == FILM_FESTIVAL_POST_TYPE ) { ?>
                                <div class = 'icon-video_play' data-grunticon-embed></div>
                            <?php } ?>
                                <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 37.5em) 25vw, 100vw'); ?>
                        </a>
                    </figure>
                    <section class = 'rubric <?php echo $post_type; ?>'>
                        <a class = 'icon icon-dept_<?php echo $post_type; ?>' href = '<?php echo $post_link; ?>'></a>
                        <h2 class = '<?php echo $post_type; ?>'><a href = '<?php echo $post_link; ?>'><?php echo $postMenuName; ?></a>
                        <span class = 'topic'><?php echo $topic_urls; ?></span></h2>
                    </section>
                    <section class = 'titles'>
                        <h1><a href = '<?php the_permalink(); ?>'><?php the_title() ?></a></h1>
                        <p><?php echo excerpt(35); ?></p>
                        <address><?php echo getAuthorDetail(get_the_ID(),1,0); ?></address>
                        <time><?php
                            if ($post_type == "magazine") {
                                $issue = get_the_terms($post->ID, "magazine-issue");
                                echo $issue[0]->name;
                            } else {
                                the_date('M Y');
                            }
                            ?></time>
                    </section>
                </article>
                <?php
                $count++;
            endwhile;
            wp_reset_query();
            ?>
              <?php if ($count == "12") { ?>
                <div class='more'>
                    <input type="hidden" name="postId" id="postId" value="<?php echo json_encode($postId); ?>" />
                    <input type="hidden" name="taxonomy" id="taxonomy" value="<?php echo 'department' ?>" />
                    <input type="hidden" name="taxname" id="taxname" value="<?php echo $tax_name; ?>" />
                    <!-- tax name, post type, url, post id's -->
                        <a href='javascript:void(0)' id="PleasePushMe">Load More</a>
                </div>
            <?php } ?>

<?php }
?> 


    </div>

    <div class = 'CTA-module'>
        <div class = 'rule'></div>
        <div class = 'CTA-ad' style = '
             background-color: #ddd;
             line-height: 1; padding: 2em;
             margin: 0 auto;
             width: 75%;
             height: 10em;
             text-align: center;
             '>
            <p>Call-to-Action Module. Can be set in the CMS to any of the following: (1) Ad served via Google DFP Small Business (TBD), (2) Daily Dharma, (3) Subscribe CTA, (4) Newletter CTA</p>
        </div>
        <div class = 'rule'></div>
    </div>
    <!--end Call to Action module -->

    <aside>

        <div class = 'aside-depts'>
            <!--start aside trikedaily -->
                <?php show_latest_trike_daily(); ?>
            <!--end aside trikedaily -->

            <!--start aside magazine -->
                <?php show_latest_magazine_article(); ?>
            <!--end aside magazine -->

            <!--start aside dharma talks -->
                <?php show_latest_dharma_talks(); ?>
            <!--end aside dharma talks -->
        </div>

        <div class = 'rule'></div>

       
<?php get_footer();
?>    