<?php get_header(); ?>
<?php
$tax = $wp_query->get_queried_object();
$tax_name = $tax->name;
$tax_slug = $tax->slug;
?>
<!-- start content -->
<div class='wrap'> 
    <!-- start landing marquee -->
    <div class='landing-marquee'>

        <header class='rubric_top'>
            <h1><?php echo $tax_name; ?></h1>
        </header>

        <main class='landing-marquee-articles'>
            <?php
            $postId = array();
            $counter = 1;
            if (have_posts()) {
                while (have_posts()) {
                    the_post();
                    $post_type = get_post_type();
                    $postValues = get_post_type_object($post_type);
                    $labels = $postValues->labels; //to fetch the menu name
                    $postMenuName = $labels->menu_name;
                    $postTypeLink = get_post_type_archive_link($post_type);
                    if ($post_type == "post") {
                        $post_type = "trikedaily";
                        $postMenuName = "Trike Daily";
                        $postTypeLink = get_permalink(get_page_id_by_slug(TRIKE_DAILY_SLUG));
                    }
                    $postId[] = get_the_ID();
                    $topics = get_topics_by_post_id(get_the_ID());
                    $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                    $issues = get_issues_by_post_id($post->ID);
                    $issues_names_without_urls = $issues && isset($issues['names_without_urls']) ? implode(", ", $issues['names_without_urls']) : "";
                    ?>
                    <article class = '<?php echo $post_type; ?>' >
                        <figure>
                            <a href = '<?php the_permalink(); ?>'>
                                <?php
                                if ($post_type == FILM_CLUB_POST_TYPE || $post_type == DHARMATALKS_POST_TYPE || $post_type == FILM_FESTIVAL_POST_TYPE) {
                                    echo "<div class='icon-video_play' data-grunticon-embed></div>";
                                }
                                ?>
                                <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 50em) 33vw,100vw'); ?>
                            </a>
                        </figure>
                        <section class = 'rubric <?php echo $post_type; ?>'>
                            <a class = 'icon icon-dept_<?php echo $post_type; ?>' href = ''></a>
                            <h2 class = '<?php echo $post_type; ?>'>
                                <a href = '<?php echo $postTypeLink; ?>'><?php echo $postMenuName; ?></a>
                                <span class = 'topic'><?php echo $topic_urls; ?></span>
                            </h2>
                        </section>
                        <section class = 'titles'>
                            <h1><a href = <?php the_permalink(); ?>><?php the_title(); ?></a></h1>
                            <p><?php
                                if ($post_type != DHARMATALKS_POST_TYPE) {
                                    if ($post_type == FILM_CLUB_POST_TYPE) {
                                        echo "";
                                    } else {
                                        the_excerpt();
                                    }
                                }
                                ?></p>
                            <address><?php echo getAuthorDetail(get_the_ID(), 1, 0); ?></address>
                            <time>
                                <?php
                                if ($post_type == MAGAZINE_POST_TYPE) {
                                    echo $issues_names_without_urls;
                                } else {
                                    the_date('M Y');
                                }
                                ?>
                            </time>
                        </section>
                    </article>   

                    <?php
                    if ($counter == 3) {
                        break;
                    }
                    $counter++;
                }
            } // end of if
            ?>
        </main>
    </div>

    <!-- end landing marquee -->

    <!-- start landing stack -->
    <?php if($counter >3) { ?>
    <div class='landing-stack'>
        <?php
        if (have_posts()) {
            $counter = 1;
            while (have_posts()) {
                the_post();
                $post_type = get_post_type();
                $postValues = get_post_type_object($post_type);
                $labels = $postValues->labels; //to fetch the menu name
                $postMenuName = $labels->menu_name;
                $postTypeLink = get_post_type_archive_link($post_type);
                if ($post_type == "post") {
                    $post_type = "trikedaily";
                    $postMenuName = "Trike Daily";
                    $postTypeLink = get_permalink(get_page_id_by_slug(TRIKE_DAILY_SLUG));
                }
                $postId[] = get_the_ID();
                $topics = get_topics_by_post_id(get_the_ID());
                $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                $issues = get_issues_by_post_id($post->ID);
                $issues_names_without_urls = $issues && isset($issues['names_without_urls']) ? implode(", ", $issues['names_without_urls']) : "";
                ?>

                <article class='<?php echo $post_type; ?>'>
                    <figure>
                        <a href='<?php the_permalink(); ?>'>
                            <?php  if ($post_type == FILM_CLUB_POST_TYPE || $post_type == DHARMATALKS_POST_TYPE || $post_type == FILM_FESTIVAL_POST_TYPE) {
                                ?> <div class = 'icon-video_play' data-grunticon-embed></div> <?php } ?>
                            <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 37.5em) 25vw, 100vw'); ?>
                        </a>
                    </figure>

                    <section class = 'rubric <?php echo $post_type; ?>'>
                        <a class = 'icon icon-dept_<?php echo $post_type; ?>' href = '<?php echo $postTypeLink; ?>'></a>
                        <h2 class = '<?php echo $post_type; ?>'><a href = '<?php echo $postTypeLink; ?>'><?php echo $postMenuName; ?></a><span class = 'topic'><?php echo $topic_urls; ?></span></h2>
                    </section>

                    <section class = 'titles'>
                        <h1><a href = <?php the_permalink(); ?>><?php the_title(); ?></a></h1>
                        <p><?php echo excerpt(35); ?></p>
                        <address><?php echo getAuthorDetail(get_the_ID(), 1, 0); ?></address>
                        <time><?php
                            if ($post_type == MAGAZINE_POST_TYPE) {
                                echo $issues_names_without_urls;
                            } else {
                                the_date('M Y');
                            }
                            ?>
                        </time>
                    </section>
                </article>

                <?php
                if ($counter == 3 || $counter == 5) {
                    ?>
                    <div class = 'CTA-module'>
                        <div class = 'rule'></div>
                        <div class = 'CTA-ad' style = '
                             background-color: #ddd;
                             line-height: 1; padding: 2em;
                             margin: 0 auto;
                             width: 75%;
                             height: 10em;
                             text-align: center;
                             '>
                            <p>Call-to-Action Module. Can be set in the CMS to any of the following: (1) Ad served via Google DFP Small Business (TBD), (2) Daily Dharma, (3) Subscribe CTA, (4) Newletter CTA</p>
                        </div>
                        <div class = 'rule'></div>
                    </div> 
                    <?php
                }

                $counter++;

                if ($counter == 6) {
                    break;
                }
            } // enf of while
        } // end of if


        if ($counter > 6) {
            ?>
            <div class='more'>
                <input type="hidden" name="postId" id="postId" value="<?php echo json_encode($postId); ?>" />
                <input type="hidden" name="taxonomy" id="taxonomy" value="<?php echo 'magazine-department' ?>" />
                <input type="hidden" name="taxname" id="taxname" value="<?php echo $tax_name; ?>" />
                <!-- tax name, post type, url, post id's -->
                <a href='javascript:void(0)' id="PleaseLoadMore" onclick="loadmoretopic()">Load More</a>
            </div>
            <?php
        }
        ?>
    </div>
    <?php } ?>

    <div class = 'rule'></div>
    <aside>
        <div class = 'aside-depts'>
            <!--start aside trikedaily -->
            <section class='aside-trikedaily'>
                <header class='rubric_small'>
                    <h1><a href='<?php echo get_permalink(get_page_id_by_slug(TRIKE_DAILY_SLUG)); ?>'><span class='icon icon-dept_trikedaily'></span>Trike Daily</a></h1>
                    <p>Daily wisdom, teachings &amp; critique</p>
                </header>

                <main>
                    <?php
                    $args = array(
                        'posts_per_page' => 1,
                        'orderby' => 'post_date',
                        'order' => 'DESC',
                        'post_status' => 'publish',
                        'suppress_filters' => true
                    );

                    $querymagazine = new WP_Query($args);
                    while ($querymagazine->have_posts()) : $querymagazine->the_post();
                        $topics = get_topics_by_post_id($post->ID);
                        $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                        ?>
                        <article>
                            <figure>
                                <a href='<?php the_permalink(); ?>'>										
                                    <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 50em) 33vw,100vw'); ?>
                                </a>
                            </figure>
                            <section>
                                <h2 class='rubric trikedaily'><span class='topic'><?php echo $topic_urls; ?></span></h2>
                                <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                                <p><?php the_excerpt() ?></p>
                                <address><?php echo getAuthorDetail(get_the_ID(), 1, 0); ?></address>
                                <time><?php the_date('M d, Y'); ?></time>
                            </section>
                        </article>
                        <?php
                    endwhile;
                    wp_reset_query();
                    ?>
                </main>
                <div class='rule-responsive'></div>
            </section>
            <!--end aside trikedaily -->

            <!--start aside magazine -->
            <section class='aside-magazine'>
                <header class='rubric_small'>
                    <h1><a href='<?php echo get_post_type_archive_link(MAGAZINE_POST_TYPE); ?>'><span class='icon icon-dept_magazine'></span>Magazine</a></h1>
                    <p>The Buddhist Review</p>
                </header>
                <main>
                    <?php
                    $args = array(
                        'posts_per_page' => 1,
                        'orderby' => 'post_date',
                        'order' => 'DESC',
                        'post_type' => MAGAZINE_POST_TYPE,
                        'post_status' => 'publish',
                        'suppress_filters' => true
                    );
                    $querymagazine = new WP_Query($args);

                    while ($querymagazine->have_posts()) : $querymagazine->the_post();
                        $topics = get_topics_by_post_id($post->ID);
                        $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";

                        $issues = get_issues_by_post_id($post->ID);
                        $issues_names_without_urls = $issues && isset($issues['names_without_urls']) ? implode(", ", $issues['names_without_urls']) : "";
                        ?>
                        <article>
                            <figure>
                                <a href='<?php the_permalink(); ?> '>
                                    <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 50em) 33vw,100vw'); ?>
                                </a>
                            </figure>
                            <section>
                                <h2 class='rubric magazine'><span class='topic'><?php echo $topic_urls; ?></span></h2>
                                <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                                <p><?php the_excerpt(); ?></p>
                                <address><?php echo getAuthorDetail(get_the_ID(), 1, 0); ?></address>
                                <time><?php echo $issues_names_without_urls; ?></time>
                            </section>
                        </article>
                        <?php
                    endwhile;
                    wp_reset_query();
                    ?>
                </main>
                <div class='rule-responsive'></div>
            </section>
            <!--end aside magazine -->

            <!--start aside dharma talks -->
            <section class='aside-dharmatalks'>
                <header class='rubric_small'>
                    <h1><a href='<?php echo get_post_type_archive_link(DHARMATALKS_POST_TYPE); ?>'><span class='icon icon-dept_dharmatalks'></span>Dharma Talks</a></h1>
                    <p>Video teachings and discussions with contemporary Buddhist teachers</p>
                </header>
                <main>
                    <?php
                    $args = array(
                        'posts_per_page' => 1,
                        'orderby' => 'post_date',
                        'order' => 'DESC',
                        'post_type' => DHARMATALKS_POST_TYPE,
                        'post_status' => 'publish',
                        'suppress_filters' => true
                    );

                    $querydharma = new WP_Query($args);
                    query_posts($querydharma);
                    while ($querydharma->have_posts()) : $querydharma->the_post();
                        $topics = get_topics_by_post_id($post->ID);
                        $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                        ?>
                        <article>
                            <figure>
                                <a href='<?php the_permalink(); ?>'>
                                    <div class='icon-video_play' data-grunticon-embed></div>
                                    <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 50em) 33vw,100vw'); ?>
                                </a>
                            </figure>
                            <section>
                                <h2 class='rubric dharmatalks'><span class='topic'><?php echo $topic_urls; ?></span></h2>
                                <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                                <address><?php echo getAuthorDetail(get_the_ID(), 0, 0); ?></address>
                                <time><?php echo get_the_time('M Y'); ?></time>
                            </section>
                        </article>
                        <?php
                    endwhile;
                    wp_reset_query();
                    ?>
                </main>
                <div class='rule-responsive'></div>
            </section>
            <!--end aside dharma talks -->
        </div>

        <div class = 'rule'></div>


        <?php get_footer();  ?>
           