<?php
/*
  Template Name: Magazine Archive
 */
?>
<?php
$post = get_post();
$pageslug = $post->post_name;
$pageUrl = get_site_url() . "/" . $pageslug . "/";
?>
<script>
    var pageurl = '<?php echo $pageUrl; ?>';
</script>
<?php echo get_header(); ?>

<!-- start content -->
<div class='wrap'>

    <!-- start magazine rubric -->
    <div class='rubric_top'>
        <h1><span class='icon icon-dept_magazine'></span>Magazine</h1>
        <p>The Buddhist Review</p>
    </div>
    <!-- end magazine rubric -->

    <!-- start archive_magazine grid -->
    <div class='archive_magazine'>
        <div class='rule'></div>
        <header class='rubric_mid magazine'>
            <h1>Back Issues</h1>
            <?php
	    $topicsYear = get_magazine_issue_terms();
	    
	    if(preg_replace("/[^0-9]/", '', $topicsYear[0]->name))
	    {
		$latest_issue_year =  preg_replace("/[^0-9]/", '', $topicsYear[0]->name);
	    }else{
		$latest_issue_year =  date('Y');
	    }
	    
            $currentYear = $latest_issue_year;
            $getSearchArr = explode($pageslug, str_replace("/", "", $_SERVER['REQUEST_URI']));
            $searchYear = isset($getSearchArr[1]) ? $getSearchArr[1] : $currentYear;
            $oldyear = "";
            ?>
            <div class='dropdown'>
                <div class='dropdown-container'>
                    <p class='button dropdown-button'>Browse By Year</p>
                    <ul class='dropdown-menu dropdown-select'>

                        <?php
                        for ($i = $currentYear; $i >= 1991; $i--) {
                            ?>
                            <li class="yeardropdown" rel="<?php echo $i; ?>"><a href='javascript:void(0);'><?php echo $i; ?></a></li>
                            <?php
                        }
                        ?>                                                
                    </ul>
                </div>
            </div>

        </header>

        <main id="moredata">
            <?php
            $topicsfinal = get_magazine_issue_terms();
	    //pr($topicsfinal);
            if(!empty($topicsfinal))
            {
            $count = 0;
            $topicsTermId = array();
            foreach ($topicsfinal as $topics) {
                if ($count == "12") {
                    break;
                }
                $t_id = $topics->term_id;
                $term_meta = get_option("taxonomy_term_$t_id");
                //$magazine_issue_cover_image = $term_meta['cover_image'];
                $year = preg_replace("/[^0-9]/", '', $topics->name);
                
                if ($year == $searchYear) {
                    $oldyear = $year;
                    ?>
                    <div class='archive-item'>
                        <?php
                        $term_link = get_term_link($topics);
                        $topics_termid[] = intval($topics->term_id);
                        ?>
                        <a href='<?php echo $term_link; ?>'>
                            <figure class='archive-cover_magazine'>
                                <?php echo get_image_with_srcset(array("image_type"=>"magazine_issue_cover_image", "term_id"=>$t_id, "source_width"=>array(800, 400), "size"=>"image-size-400", "attr_sizes"=>'(min-width: 60em) 33vw,(min-width: 37.5em) 50vw,75vw')); ?>
                                <?php //echo getImagewithSrcset($magazine_issue_cover_image, 'image-size-400', '', '(min-width: 60em) 33vw,(min-width: 37.5em) 50vw,75vw'); ?>
                            </figure>
                            <header class='archive-titles'>
                                <time class='h2'><?php echo $topics->name; ?>
                                    <span class='vol-no'><?php
                                        if (!empty($term_meta['volume'])) {
                                            echo "Volume " . $term_meta['volume'] . ",";
                                        }
                                        ?><?php
                                        if (!empty($term_meta['number'])) {
                                            echo " Number " . $term_meta['number'];
                                        }
                                        ?>
                                    </span>
                                </time>
                            </header>
                        </a>
                    </div>
                    <?php
                }
                

                if (empty($searchYear)) {  //if no search year is there access all the values
                    $oldyear = "";
                    ?>
                    <div class='archive-item'>
                        <?php
                        $term_link = get_term_link($topics);
                        $topics_termid[] = intval($topics->term_id);
                        ?>
                        <a href='<?php echo $term_link; ?>'>
                            <figure class='archive-cover_magazine'>
                                <?php echo get_image_with_srcset(array("image_type"=>"magazine_issue_cover_image", "term_id"=>$t_id, "source_width"=>array(800, 400), "size"=>"image-size-400", "attr_sizes"=>'(min-width: 60em) 33vw,(min-width: 37.5em) 50vw,75vw')); ?>
                                <?php //echo getImagewithSrcset($magazine_issue_cover_image, 'image-size-400', '', '(min-width: 60em) 33vw,(min-width: 37.5em) 50vw,75vw'); ?>
                            </figure>

                            <header class='archive-titles'>
                                <?php $topicsTermId[] = $topics->term_id; ?>
                                <time class='h2'><?php echo $topics->name; ?>
                                    <span class='vol-no'>
                                        <?php
                                        if (!empty($term_meta['volume'])) {
                                            echo "Volume " . $term_meta['volume'] . ", ";
                                        }
                                        ?>
                                        <?php
                                        if (!empty($term_meta['number'])) {
                                            echo "Number " . $term_meta['number'] ;
                                        } else {
                                            echo "<br>";
                                        }
                                        ?> 
                                    </span></time>
                            </header>
                        </a>
                    </div>

                    <?php
                    $count++;
                }
            } //end of for each loop         
            ?>
        </main>
        <?php if ($oldyear != "1991" && !empty($topics_termid)) {
            ?>
            <div style="clear:both"></div>
            <div id="loadingimage" style="position:relative"></div>
            <div class='more magazine'>
                <input type="hidden" name="oldyear" id="oldyear" value="<?php echo $oldyear; ?>" />
                <input type="hidden" name="TopicstermId" id="TopicstermId" value='<?php echo json_encode($topics_termid); ?>' />
                <a class='button' href='javascript:void(0)' id="loadmoremagazine" onclick='LoadMoreMagazine()'>Load More</a>
            </div>
        <?php }
        }//end of checking empty topic final
        ?>

    </div>
        <!-- end archive_magazine grid -->
        <!-- start Call to Action module -->
    <div class='CTA-module'>
    <?php
    //function to get ad from the database 
    get_the_ad("magazine_archive_ad_");
    ?>
    </div>
    <!-- end Call to Action module -->
    <aside>
        <div class='aside-depts'>
            <!-- start aside trikedaily -->
            <?php show_latest_trike_daily(); ?>
            <!-- end aside trikedaily -->

            <!-- start aside ebooks -->
            <?php show_latest_ebooks(); ?>
            <!-- end aside ebooks -->

            <!-- start aside dharma talks -->
            <?php show_latest_dharma_talks(); ?>
            <!-- end aside dharma talks -->
        </div>
        <div class='rule'></div>
        <?php echo get_footer(); ?>
