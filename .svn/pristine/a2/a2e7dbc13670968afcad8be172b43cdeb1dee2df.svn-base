<?php get_header(); ?>
<?php
global $wp_query;
if(isset($wp_query->query_vars['dtv']))
{
    
}
?>
<?php

$postId = get_the_ID();
$topics = get_topics_by_post_id($postId);
$topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
$objPost = get_post($postId);

/* call setPostView() function for increasing view counter of the post */
setPostViews($postId);


$upload_dir = wp_upload_dir();
$uploadDirectory = $upload_dir['basedir']."/";
?>
<script>
var downloadpdf = "<?php echo get_site_url(); ?>/download.php?file=<?php echo $uploadDirectory ?>";	
</script>
<!-- start content -->
		<div class='wrap_outer_base'>

			<!-- <header class='rubric_top dharmatalks'>
					<h1><span class='icon icon-dept_dharmatalks'></span>Dharma Talks</h1>
					<p>Video teachings and discussions with contemporary Buddhist teachers</p>
					<a class='button' href='#'>Dharma Talks Archive</a>
			</header> -->

			<main class='wrap_base'>

				<!-- start article -->
				<article class='article_dharmatalks dharmatalks'>
					<header class='article-header_video'>
						<h2 class='rubric dharmatalks'>
							<a href='<?php echo bloginfo('url')."/".DHARMATALKS_POST_TYPE ?>' class='icon icon-dept_dharmatalks'></a>
							<span class='dept'><a href='<?php echo bloginfo('url')."/".DHARMATALKS_POST_TYPE ?>'>Dharma Talks</a></span>
							<span class='topic'><?php echo $topic_urls; ?></span>
						</h2>
						<time><?php echo get_the_date('M Y'); ?></time>
						<h1><?php the_title(); ?></h1>
						<address><a href=''><?php echo getAuthorDetail(get_the_ID(),0,0); ?></a></address>
					</header>
					<!-- start article body -->
					<main class='article-main_dharmatalks'>
						<div class='article-video_featured dharmatalks'>
							<figure>
								<div class='icon-video_play' rel="<?php echo get_post_meta($postId ,'dharma_talks_trailer_url',true); ?>" data-grunticon-embed></div>
								<?php echo srcset_post_thumbnail(get_the_ID(), 'image', '','(min-width: 50em) 75vw,100vw'); ?>
								
								<div class='video-wrapper'>
								</div>
							</figure>
						</div>
						
						
						<?php
								
							$metavideo = array();
							$metavideosSet = array();
							
							$postmetavideo =  get_post_meta(get_the_ID());
							//pr($postmetavideo);
							$i=$j=$k = 1;
							foreach($postmetavideo as $metakey=>$value)
							{ 		//echo $metakey."<hr>"."dharma_talks_video".$i."_title"."<hr>";
								if($metakey == "dharma_talks_video".$i."_title"){
									
									$metavideo[$i]['video_title'] = $value[0];
									$i++;
								}
								
								if(strstr($metakey,"dharma_talks_video".$j."_url")){
									$metavideo[$j]['video_url'] = $value[0];
									$j++;
								}
								
								if(strstr($metakey,"dharma_talks_video".$k."_time_length")){
									$metavideo[$k]['video_duration'] = $value[0];
									$k++;
								}
								
							}
								
						?>
						
						<?php if(!empty($metavideo)){ ?>
							<div class='article_playlist'>
								<ol>
									<?php 	$totalvideo = 0;
										$trailertitle = get_post_meta(get_the_ID(),'dharma_talks_trailer_url',true);
										if($trailertitle!=""){
										$totalvideo = 1;
											
									?>
									<li>
										<a href="javascript:void(0);" videonumber="1" class="js_playvideo" linkpdf="<?php echo get_post_meta(get_the_ID() ,DHARMA_TALKS_TRAILER_TRANSCRIPTS_PDF_URL_META_KEY,true); ?>" rel="<?php echo get_post_meta(get_the_ID(),'dharma_talks_trailer_url',true); ?>" videotitle="<?php echo get_post_meta(get_the_ID(),'dharma_talks_trailer_title', true); ?>">
											<h1 class="play"><?php echo get_post_meta(get_the_ID(),'dharma_talks_trailer_title',true); ?><span class="duration h2"><?php echo get_post_meta(get_the_ID(),'dharma_talks_trailer_time_length',true); ?></span></h1>
										</a>
									</li>
									<?php } ?>
									<?php	
										$videoList = 2;
										$pdfdownload =1;
										//$totalvideo = 0;
										foreach($metavideo as $postmetavideo){
											if($postmetavideo['video_title']!=""){
												if(is_post_behind_paywall($postId)){												
													if($videoList >= 3 && !isset($paywall_login)){
														$relValue = "";
														$linkpdf = "";
													}else{
														$relValue = $postmetavideo['video_url'];
														$metapdf = "dharma_talks_video".$pdfdownload."_transcripts_pdf_url";
														if($metapdf!=""){
															$linkpdf = get_post_meta(get_the_ID() ,$metapdf,true);
														}
													}
												}else{
													$relValue = $postmetavideo['video_url'];
													$metapdf = "dharma_talks_video".$pdfdownload."_transcripts_pdf_url";
													if($metapdf!=""){
														$linkpdf = get_post_meta(get_the_ID() ,$metapdf,true);
													}
												}
											?>
										<li>
											<a href='javascript:void(0)' videonumber="<?php echo $videoList; ?>" linkpdf="<?php echo $linkpdf; ?>" class="js_playvideo" rel="<?php echo $relValue; ?>" videotitle="<?php echo $postmetavideo['video_title']; ?>">
												<h1><?php echo $postmetavideo['video_title']; ?><span class='duration h2'><?php echo $postmetavideo['video_duration']; ?></span></h1>
											</a>
										</li>
									<?php
										$totalvideo++;
										$videoList++;
										$pdfdownload++;
											}
										}
									?>									
								</ol>
							</div>
						<?php } ?>
						

						<div class='tools_top'>
							<ul>
								<li><a class='icon icon-tools_facebook' href='#' data-grunticon-embed></a></li>
								<li><a class='icon icon-tools_twitter' href='#' data-grunticon-embed></a></li>
								<li><a class='icon icon-tools_email' href='#' data-grunticon-embed></a></li>
								<li><a class='icon icon-tools_print' href='#' data-grunticon-embed></a></li>
							</ul>
						</div>

						<div class='article-dharmatalk-title'>
							<div class='queue'>
								<p class='h2'>Playing <span class="videonum">1</span> of <?php echo $totalvideo; ?></p>
							</div>
								<h1 class="js_videoTitle"><?php echo get_post_meta(get_the_ID(),'dharma_talks_trailer_title', true); ?></h1>
							<p class='transcript'>
								<?php
									$downloadPDF  =  get_post_meta(get_the_ID() ,DHARMA_TALKS_TRAILER_TRANSCRIPTS_PDF_URL_META_KEY,true);
									// get_post_meta(get_the_ID() ,DHARMA_TALKS_VIDEO1_TRANSCRIPTS_PDF_URL_META_KEY,true);									
								?>
								<a class='h2' id="pdf_download" href='<?php echo get_site_url(); ?>/download.php?file=<?php echo urlencode($uploadDirectory.$downloadPDF); ?>'>Download Transcript</a>It has been edited for clarity.</p>
						</div>

						<section class='article-body'>
							<?php echo $objPost->post_content; ?>
						</section>

						<div class='article-bottom-matter'>
							
							<?php
								$dharma_tags_array = wp_get_post_tags(get_the_ID());
								if(!empty($dharma_tags_array)){
							?> 
							<section class='article-tags'>
								<ul>
									<?php foreach($dharma_tags_array as $tags){ ?>
										<li><p class='tag'><a href='<?php echo get_tag_link($tags->term_id); ?>'><?php echo ucfirst($tags->name); ?></a></p></li>
									<?php } ?>
									
								</ul>
							</section>
							
							<?php } ?>
							
							<?php
							if ( comments_open() || get_comments_number() ) :
							?>
							    <div class='comments-toggle showcomments'>
								<a href='javascript:void(0);' id="commentlink_title">Ask the Teacher a Question</a>
							    </div>
							<?php
								    comments_template();
							    endif;
							?>
							
							
						</div>
					</main>
				</article>

			</main>
			<!-- end article wrap -->

			<aside>
				<!-- start related -->
				<!-- start most popular module -->
				<?php
				$mostpopularpost  = getMostViewPosts(DHARMATALKS_POST_TYPE,$postId,3);
				
				if(!empty($mostpopularpost))
				{
				
				?>
				<div class='related-posts'>
					<header class='rubric_top'>
							<h1>Most Popular</h1>
					</header>

					<main>
						<?php
						
							foreach($mostpopularpost as $mostpopular)
							{
                                                             $topics = get_topics_by_post_id($post->ID);
                                                             $topic_urls = $topics && isset($topics['urls']) ? implode(", ", $topics['urls']) : "";
						?>
					
						<article class='dharmatalks'>
							<figure>
								<a href='<?php echo $mostpopular['permalink']; ?>'>
										<div class='icon-video_play' data-grunticon-embed></div>
										<?php echo srcset_post_thumbnail($mostpopular['postId'], 'image', '','(min-width: 50em) 33vw,100vw'); ?>
								</a>
							</figure>
							<section>
								<h2 class='rubric dharmatalks'><span class='topic'><?php echo $topic_urls; ?></span></h2>
								<h1><a href='<?php echo $mostpopular['permalink']; ?>'><?php echo $mostpopular['title']; ?></a></h1>
								<address><?php echo getAuthorDetail($mostpopular['postId'],0,0); ?></address>
								<time><?php echo $mostpopular['publish_date']; ?></time>
							</section>
						</article>
						
						<?php  }  ?>
					</main>
				</div>

				<?php } ?>

				<div class='rule'></div>

				
<?php get_footer(); ?>