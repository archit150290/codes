<?php

/**
 * @package Marquee
 * @version 1.6
 */
/*
  Plugin Name: Marquee
  Plugin URI:
  Description: This Marquee is used to set the element with drag and drop method.
  Author:
  Version:
  Author URI:
 */

function my_menu_pages_marquee() {
    add_menu_page('Home Page Marquee', 'Home Page Management', 'manage_options', 'marqueepage', 'feature_marquee', 'dashicons-controls-repeat', 7);
    add_submenu_page('marqueepage', 'Feature Marquee', 'Feature Marquee', 'manage_options', 'marqueepage', 'feature_marquee');
    add_submenu_page('marqueepage', 'Home Page Current Issues', 'Home Page Current Issue', 'manage_options', 'homepageissues', 'Home_issues_marquee');
    add_submenu_page('edit.php?post_type=magazine', 'Manage Article Sequence', 'Manage Article Sequence', 'manage_options', 'currentissues', 'current_issues_marquee');
}

add_action('admin_menu', 'my_menu_pages_marquee');

add_action('init', 'my_admin_scripts');

function my_admin_scripts() {
    wp_enqueue_script('jquery-ui-sortable');
}

function feature_marquee($post) {
    global $wpdb;
    //query is here to check if there is any value at the initials or not
    $results = $wpdb->get_results( 'SELECT * FROM '.$wpdb->prefix.'postmeta WHERE meta_key = "menu_order_marquee"' );
    
    if($results)
    {
        add_filter('pre_get_posts', 'change_order_marquee');

        function change_order_marquee($wp_query) {
            $wp_query->set('meta_key', 'menu_order_marquee');
            $wp_query->set('orderby', 'meta_value');
            $wp_query->set('order', 'ASC');
        }
    }
    
    $args = array(
        'post_type' => array('post', MAGAZINE_POST_TYPE, DHARMATALKS_POST_TYPE, FILM_CLUB_POST_TYPE, EBOOKS_POST_TYPE, FILM_FESTIVAL_POST_TYPE),
        'post_status' => 'publish',
        'meta_query' => array(
            array(
                'key' => 'home_featured',
                'value' => '1',
                'compare' => 'IN',
            ),
        ),
    );
    $eq_query = new WP_Query($args);
    global $post;
    ?>
    <div class="wrap">
        <h2>Welcome To Marquee</h2>
        <h3 id="order_updated">Set Home Page Marquee:- Drag and Drop to change the positions</h3>
        <table id="marquee" class="widefat">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Category</th>
                </tr>
            </thead>
            <tfoot>
                <tr>
                    <th>Title</th>
                    <th>Category</th>
                </tr>
            </tfoot>
            <tbody id="sortable_ui">
                <?php while ($eq_query->have_posts()): $eq_query->the_post();
                $post_type = get_post_type();
                $post_slug = "edit.php?post_type=".$post_type;
                    if($post_type == "post")
                    {
                        $post_type = "Trike Daily";
                        $post_slug = "edit.php?post_type=post";
                    }
                    ?>
                    <tr id="recordsArray_<?php echo $post->ID; ?>">
                        <td><a href="post.php?post=<?php echo $post->ID; ?>&action=edit"><?php the_title(); ?></a></td>
                        <td><a href="<?php echo $post_slug; ?>"><?php echo $post_type;?></a></td>
                    </tr>
                    <?php 
                endwhile;
            wp_reset_query();
            ?>  
            </tbody>
        </table>
        <script type="text/javascript">
            jQuery(document).ready(function () {
                jQuery("table#marquee tbody").sortable({update: function () {
                        var order = jQuery(this).sortable("serialize") + '&action=updateRecordsListings';
                        jQuery.post("<?php echo WP_PLUGIN_URL . '/marquee/' ?>update-sequence.php", order, function (theResponse) {
                            if (theResponse == 0 || theResponse == "Error.")
                            {
                                
                                 alert('Order can not be updated. Please try after sometimes.');
                            }
                            else
                            {
                                jQuery("#sortable_ui").html(theResponse);
                                jQuery("#order_updated").text("Updating the sort Order...");
                                setTimeout(function(){jQuery("#order_updated").text("Order Updated");},1000);
                                //setTimeout(function(){alert("Order updated successfully");},2000);
                            }
                        });
                    }
                });
            });
        </script>
    </div>
    <?php
}

function Home_issues_marquee($post) {
    global $post;
    $recentissue = get_magazine_issue_terms();
    $recentissueName = isset($recentissue[0]) ? $recentissue[0]->name : '';
    add_filter('pre_get_posts', 'change_order');
    function change_order($wp_query) {
        $wp_query->set('meta_key', 'menu_order');
        $wp_query->set('orderby', 'meta_value');
        $wp_query->set('order', 'ASC');
    }
    $argscissue = array(
        'post_type' => array(MAGAZINE_POST_TYPE),
        'post_status' => 'publish',
        'tax_query' => array(
            'relation' => 'AND',
            array(
                'taxonomy' => 'magazine-issue',
                'field' => 'slug',
                'terms' => array($recentissueName),
                'operator' => 'IN',
            ),
        ),
        'meta_query' => array(
            array(
                'key' => 'current_issue_meta_key',
                'value' => '1',
                'compare' => 'IN',
            ),
        ),
    );
    $eq_query = new WP_Query($argscissue);
    ?>
    <div class="wrap">
        <h2><?php echo $recentissueName;?></h2>
        <h3>Set Home Page Current Issues: Drag and drop to change the positions. </h3>
    </div>

    <table id="marquee" class="widefat">
        <thead>
            <tr>
                <th>Title</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th>Title</th>
            </tr>
        </tfoot>
        <tbody id="sortable_ui">
            <?php
            while ($eq_query->have_posts()): $eq_query->the_post();
                $abc = get_post_meta($post->ID, 'menu_order', true);
                ?>
                <tr id="recordsArray_<?php echo $post->ID; ?>">
                    <td><a href="post.php?post=<?php echo $post->ID; ?>&action=edit"><?php the_title(); ?></a></td>
                </tr>
                <?php
            endwhile;
            wp_reset_query();
            ?>  
        </tbody>
    </table>
    <script type="text/javascript">
        jQuery(document).ready(function () {
            jQuery("table#marquee tbody").sortable({update: function () {
                    var order = jQuery(this).sortable("serialize") + '&action=updateCurrentIssues';
                    jQuery.post("<?php echo WP_PLUGIN_URL . '/marquee/' ?>update-sequence.php", order, function (theResponse) {
                        if (theResponse == 0 || theResponse == "Error.")
                        {
                            alert('Order can not be updated. Please try after sometimes.');
                        }
                        else
                        {
                            jQuery("#sortable_ui").html(theResponse);
                            alert('Order updated successfully.');
                        }
                    });
                }
            });
        });
    </script>
    <?php
}

function current_issues_marquee()
{?>
    <div class="wrap">
        <h2>Manage Sequence</h2>
            <form action="" method="post">
            <table>
            <tbody>
            <tr>
                <th scope="row"><label for="blogname">Issues</label></th>
                <td>
                    <select id="magazineissues" name="magazineissues">
                        <option selected="true" style="display: none;">Select Issue</option>
                        <?php $topicsfinal = get_magazine_issue_terms();
                        foreach($topicsfinal as $Topics)
                            {    
                            $topicsName = $Topics->name;
                            $topicsSlug = $Topics->slug;
                            $topicsTermurl = $Topics->term_url;
                            echo '<option value = "'.$topicsSlug.'">'.$topicsName.'</option>';
                            }
                        ?>
                    </select>
                </td>
                 <th scope="row"><label for="blogname">Sections</label></th>
                <td>
                    <select id="magazinedepartments" name="magazinedepartments">
                        <option selected="true" style="display: none;">Select Department</option>
                        <option value="special-sections">Special Sections</option>
                        <option value="features">Features</option>
                        <option value="departments">Departments</option>
                        <option value="columns">Columns</option>
                    </select>
                </td>
                <td>
                    <label><input id="submitOption" class="button button-primary" type="submit" name="submit" value="Search Articles"></label>
                </td>
             </tr>
            </tbody>
            </table>
            </form>
        
        
        <?php
        if(isset($_REQUEST['submit']))
        {   
            global $post;
            $magazine_issues = $_REQUEST['magazineissues'];
            $magazine_departments = $_REQUEST['magazinedepartments'];
            $args = array(
                'post_type' => array(MAGAZINE_POST_TYPE),
                'tax_query' => array(
                    'relation' => 'AND',
                    array(
                        'taxonomy' => MAGAZINE_POST_DEPARTMENT_TAXONOMY,
                        'field' => 'slug',
                        'terms' => array($magazine_departments),
                        'operator' => 'IN',
                    ),
                    array(
                        'taxonomy' => 'magazine-issue',
                        'field' => 'slug',
                        'terms' => $magazine_issues,
                        'operator' => 'IN',
                    ),
                ),
                'post_status' => 'publish',
                'order' => 'ASC',
                'orderby' => 'menu_order',
                'posts_per_page' => '-1'
            );
            $eq_query = new WP_Query($args);
            ?>
            <table id="marquee" class="widefat">
            <thead>
                <tr>
                    <th>Title</th>
                    <!--<th>Menu Order</th>-->
                </tr>
            </thead>
            <tfoot>
                <tr>
                    <th>Title</th>
                    <!--<th>Menu order</th>-->
                </tr>
            </tfoot>
            <tbody id="sortable_ui">
                <?php 
                if($eq_query->have_posts())
                {
                echo '<p>Drag and Drop to change the sequence, Articles will appear in same order as they are here.</p>';
                while($eq_query->have_posts())
                {
                    $eq_query->the_post();?>
                    <tr id="recordsArray_<?php echo $post->ID; ?>">
                        <td><a href="post.php?post=<?php echo $post->ID; ?>&action=edit"><?php the_title(); ?></a></td>
                        <td><?php //echo $abc; ?></td>
                    </tr>

               <?php }
                }?>
            </tbody>    
        </table>
        <script>
        jQuery(document).ready(function(){
                var magazineIssue = '<?php echo $magazine_issues; ?>';
                var magazineDepartment = '<?php echo $magazine_departments; ?>';
                jQuery('table#marquee tbody').sortable({update: function(){
                var order = jQuery(this).sortable("serialize")+'&action=updateissues'+'&magazine-issue='+magazineIssue+'&magazine-department='+magazineDepartment;
                jQuery.post("<?php echo WP_PLUGIN_URL . '/marquee/' ?>update-sequence.php", order, function (theResponse) {
                        if (theResponse == 0 || theResponse == "Error.")
                        {
                            alert('Order can not be updated. Please try after sometimes.');
                        }
                        else
                        {
                            jQuery("#sortable_ui").html(theResponse);
                            alert('Order updated successfully.');
                        }
                    });
           }
            }) ;
        });
        </script>
        <?php }
        ?>
    </div>
<?php }?>
