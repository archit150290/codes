<?php get_header(); ?>
<!-- start content -->
<?php
$tax = $wp_query->get_queried_object();
$tax_name = $tax->name;
$tax_id = $tax->term_id;
?>

<div class='wrap'>

    <?php
    $topicsfinal = get_magazine_issue_terms();
    for ($i = 0; $i < count($topicsfinal); $i++) {
        $topicid[] = $topicsfinal[$i]->term_id;
        $term_link = get_term_link($topicsfinal[$i]);
        if (in_array($tax_id, $topicid)) {
            $i;
            break;
        }
    }
    ?>
    <?php
    /* condition to get the next and previous values from the index find above. */
    $lastvalue = count($topicsfinal)-1;
    if($i!= $lastvalue)
    { 
        $prev_value = $i + 1;
    }
    if ($i != 0) {
        $next_value = $i - 1;
    }
    
    if($i!= $lastvalue)
    { 
    $previous_tax_url = $topicsfinal[$prev_value]->term_url;
    }
    
    if ($i != 0) {
        $next_tax_url = $topicsfinal[$next_value]->term_url;
    }
    ?>
    <!-- start magazine landing marquee -->
    <div class='landing-marquee magazine'>
        <header class='rubric_top'>
            <h1><span class='icon icon-dept_magazine'></span>Magazine</h1>
            <p>The Buddhist Review</p>
            <a class='button' href='<?php echo get_permalink(get_page_id_by_slug("magazine-archive")); ?>'>Back Issues</a>
        </header>

        <main class='slider'>

            <div class='rule'></div>
            <!-- arrow-off for arrow off -->
            <?php if ($i != 0) { ?>
                <div class='slider-next'>
                <?php } else { ?>  
                    <div class='slider-next arrow-off'>
                    <?php } ?>
                    <button class='icon-arrow_left' data-grunticon-embed onclick="gotonexturl()"></button>
                    <script>
                        function gotonexturl()
                        {
                            var nexturl = "<?php echo $next_tax_url; ?>";
                            setTimeout(function () {
                                window.location.href = nexturl
                            }, 50);
                        }
                    </script>
                </div>
                </form>
                <figure class='slider-cover'>
                    <?php
                    $t_id = $tax->term_id;
                    $term_meta = get_option("taxonomy_term_$t_id");
                    $magazine_issue_cover_image = $term_meta['cover_image'];
                    ?>
                    <?php echo getImagewithSrcset($magazine_issue_cover_image, 'image', '', '(min-width: 60em) 33vw,(min-width: 37.5em) 50vw,75vw'); ?>
                    <?php if (!empty($term_meta['cover_image_credit'])) { ?><figcaption>Illustration by <?php echo $term_meta['cover_image_credit']; ?></figcaption><?php }
                    else {?>
                    <figcaption></figcaption>
                    <?php } ?>
                </figure>
                <?php if($i!= $lastvalue) { ?>
                <div class='slider-prev'>
                    <button class='icon-arrow_right' onclick="gotoprevurl()" data-grunticon-embed></button>
                </div>
                <?php }
                else { ?>
                <div class='slider-prev  arrow-off'>
                <button class='icon-arrow_right'  data-grunticon-embed></button>
                </div> 
                
                <?php } ?>
                
                <script>
                    function gotoprevurl()
                    {
                        var prevurl = "<?php echo $previous_tax_url; ?>";
                        setTimeout(function () {
                            window.location.href = prevurl
                        }, 50);
                    }
                </script>
                
                <header class='slider-date'>
                    <time class='h2'><?php echo $tax_name; ?><span class='vol-no'><?php
                            if (!empty($term_meta['volume'])) {
                                echo "Volume " . $term_meta['volume'] . ",";
                            }
                            ?><?php
                            if (!empty($term_meta['number'])) {
                                echo " Number " . $term_meta['number'];
                            }
                            ?></span></time>
                </header>


        </main>
    </div>
    <!-- end magazine landing marquee -->

    <!-- start stack title -->
    <div class='landing-stack-slug magazine'>
        <h2 class='button'>In This Issue </h2>
    </div>
    <!-- end stack title -->

    <!-- start magazine landing stack -->
    <div class='landing-stack'>
        <section class='magazine-section'>

            <?php
            $args = array(
                'post_type' => array(MAGAZINE_POST_TYPE),
                'tax_query' => array(
                    'relation' => 'AND',
                    array(
                        'taxonomy' => MAGAZINE_POST_DEPARTMENT_TAXONOMY,
                        'field' => 'slug',
                        'terms' => array('special-sections'),
                        'operator' => 'IN',
                    ),
                    array(
                        'taxonomy' => 'magazine-issue',
                        'field' => 'slug',
                        'terms' => $tax_name,
                        'operator' => 'IN',
                    ),
                ),
                'post_status' => 'publish',
                'order' => 'ASC',
                'orderby' => 'menu_order',
                'posts_per_page' => '-1'
            );
            $eq_query = new WP_Query($args);
            $count_number_post = $eq_query->post_count;

            if ($count_number_post != "0") {
                ?>
                <header class = 'rubric_mid'>
                    <h1>Special Sections</h1>
                </header>
                <?php
                while ($eq_query->have_posts()): $eq_query->the_post();
                    $byline = get_post_meta($post->ID, 'authors_select_metabox', true);
                    $byauthor = get_post_meta($post->ID, 'authors_name_metabox', true);
                    $topics = get_topics_by_post_id(get_the_ID());
                    $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                    ?>
                    <main>
                        <article class='magazine'>
                            <?php
                            if(has_post_thumbnail())
                            {
                                ?>
                                <figure>
                                    <a href='<?php the_permalink(); ?>'>
                                        <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 37.5em) 25vw,100vw'); ?>
                                    </a>
                                </figure>
                                <?php
                            }
                            ?>
                            <section class='rubric magazine'>
                                <h2 class='magazine'>
                                    <?php
                                    get_the_sub_department($post->ID, MAGAZINE_POST_DEPARTMENT_TAXONOMY);
                                    ?>        
                                    <span class='topic'><?php echo $topic_urls; ?></span></h2>
                            </section>
                            <section class='titles'>
                                <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                                <?php has_excerpt() ? the_excerpt() : ""; ?>
                                <address><?php echo getAuthorDetail($post->ID, 1, 1); ?></address>
                            </section>
                        </article>

                        <?php
                    // end of counter that is counting number of post


                    endwhile;
                }
                wp_reset_query();
                ?>

            </main>
        </section>


        <section class='magazine-section'>
            <?php
            $args = array(
                'post_type' => array(MAGAZINE_POST_TYPE),
                'tax_query' => array(
                    'relation' => 'AND',
                    array(
                        'taxonomy' => MAGAZINE_POST_DEPARTMENT_TAXONOMY,
                        'field' => 'slug',
                        'terms' => array('features'),
                        'operator' => 'IN',
                    ),
                    array(
                        'taxonomy' => 'magazine-issue',
                        'field' => 'slug',
                        'terms' => $tax_name,
                        'operator' => 'IN',
                    ),
                ),
                'post_status' => 'publish',
                'order' => 'ASC',
                'orderby' => 'menu_order',
                'posts_per_page' => '-1'
            );
            $eq_query = new WP_Query($args);
            $count_number_post = $eq_query->post_count;

            if ($count_number_post != "0") {
                ?>
                <header class='rubric_mid'>
                    <h1>Features</h1>
                </header>
                <?php
                while ($eq_query->have_posts()): $eq_query->the_post();
                    $byline = get_post_meta($post->ID, 'authors_select_metabox', true);
                    $byauthor = get_post_meta($post->ID, 'authors_name_metabox', true);
                    $topics = get_topics_by_post_id(get_the_ID());
                    $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                    ?>
                    <main>
                        <article class='magazine'>
                            <?php
                            if(has_post_thumbnail())
                            {
                                ?>
                                <figure>
                                    <a href='<?php the_permalink(); ?>'>
                                        <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 37.5em) 25vw,100vw'); ?>
                                    </a>
                                </figure>
                                <?php
                            }
                            ?>
                            <section class='rubric magazine'>
                                <h2 class='magazine'>
                                    <?php
                                    get_the_sub_department($post->ID, MAGAZINE_POST_DEPARTMENT_TAXONOMY);
                                    ?>   
                                    <span class='topic'><?php echo $topic_urls; ?></span></h2>
                            </section>
                            <section class='titles'>
                                <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                                <?php has_excerpt() ? the_excerpt() : ""; ?>
                                <address><?php echo getAuthorDetail($post->ID, 1, 1); ?></address>
                            </section>
                        </article>

                        <?php
                    // end of counter that is counting number of post


                    endwhile;
                }
                wp_reset_query();
                ?>

            </main>
        </section>


        <section class='magazine-section'>
            <?php
            $args = array(
                'post_type' => array(MAGAZINE_POST_TYPE),
                'tax_query' => array(
                    'relation' => 'AND',
                    array(
                        'taxonomy' => MAGAZINE_POST_DEPARTMENT_TAXONOMY,
                        'field' => 'slug',
                        'terms' => array('departments'),
                        'operator' => 'IN',
                    ),
                    array(
                        'taxonomy' => 'magazine-issue',
                        'field' => 'slug',
                        'terms' => $tax_name,
                        'operator' => 'IN',
                    ),
                ),
                'post_status' => 'publish',
                'order' => 'ASC',
                'orderby' => 'menu_order',
                'posts_per_page' => '-1'
            );
            $eq_query = new WP_Query($args);
            $count_number_post = $eq_query->post_count;

            if ($count_number_post != "0") {
                ?>  
                <header class='rubric_mid'>
                    <h1>Departments</h1>
                </header>
                <?php
                while ($eq_query->have_posts()): $eq_query->the_post();
                    $byline = get_post_meta($post->ID, 'authors_select_metabox', true);
                    $byauthor = get_post_meta($post->ID, 'authors_name_metabox', true);
                    $topics = get_topics_by_post_id(get_the_ID());
                    $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                    ?>
                    <main>
                        <article class='magazine'>
                            <?php
                            if(has_post_thumbnail())
                            {
                                ?>
                                <figure>
                                    <a href='<?php the_permalink(); ?>'>
                                        <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 37.5em) 25vw,100vw'); ?>
                                    </a>
                                </figure>
                                <?php
                            }
                            ?>
                            <section class='rubric magazine'>
                                <h2 class='magazine'>
                                    <?php
                                    get_the_sub_department($post->ID, MAGAZINE_POST_DEPARTMENT_TAXONOMY);
                                    ?>        
                                    <span class='topic'><?php echo $topic_urls; ?></span></h2>
                            </section>
                            <section class='titles'>
                                <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                                <?php has_excerpt() ? the_excerpt() : ""; ?>
                                <address><?php echo getAuthorDetail($post->ID, 1, 1); ?></address>
                            </section>
                        </article>

                        <?php
                    // end of counter that is counting number of post


                    endwhile;
                }
                wp_reset_query();
                ?>
            </main>
        </section>
        <!-- </div> -->
    </div>
        <!-- start Call to Action module -->
        <div class='CTA-module'>
           <?php get_the_ad("magazine_ad_"); ?>
        </div>
        <!-- end Call to Action module -->

        <!-- <div class='landing-stack'> -->
        <div class="landing-stack">
        <section class='magazine-section'>
            <?php
            $args = array(
                'post_type' => array(MAGAZINE_POST_TYPE),
                'tax_query' => array(
                    'relation' => 'AND',
                    array(
                        'taxonomy' => MAGAZINE_POST_DEPARTMENT_TAXONOMY,
                        'field' => 'slug',
                        'terms' => array('columns'),
                        'operator' => 'IN',
                    ),
                    array(
                        'taxonomy' => 'magazine-issue',
                        'field' => 'slug',
                        'terms' => $tax_name,
                        'operator' => 'IN',
                    ),
                ),
                'post_status' => 'publish',
                'order' => 'ASC',
                'orderby' => 'menu_order',
                'posts_per_page' => '-1'

            );
            $eq_query = new WP_Query($args);
            $count_number_post = $eq_query->post_count;

            if ($count_number_post != "0") {
                ?>
                <header class='rubric_mid'>
                    <h1>Columns</h1>
                </header>
                <?php
                while ($eq_query->have_posts()): $eq_query->the_post();
                    $byline = get_post_meta($post->ID, 'authors_select_metabox', true);
                    $byauthor = get_post_meta($post->ID, 'authors_name_metabox', true);
                    $topics = get_topics_by_post_id(get_the_ID());
                    $topic_urls = $topics && isset($topics['names_with_urls']) ? implode(", ", $topics['names_with_urls']) : "";
                    ?>
                    <main>
                        <article class='magazine'>
                            <?php
                            if(has_post_thumbnail())
                            {
                                ?>
                                <figure>
                                    <a href='<?php the_permalink(); ?>'>
                                        <?php echo srcset_post_thumbnail(get_the_ID(), 'image', '', '(min-width: 37.5em) 25vw,100vw'); ?>
                                    </a>
                                </figure>
                                <?php
                            }
                            ?>
                            <section class='rubric magazine'>
                                <h2 class='magazine'>
                                    <?php
                                    get_the_sub_department($post->ID, MAGAZINE_POST_DEPARTMENT_TAXONOMY);
                                    ?>
                                    <span class='topic'><?php echo $topic_urls; ?></span></h2>
                            </section>
                            <section class='titles'>
                                <h1><a href='<?php the_permalink(); ?>'><?php the_title(); ?></a></h1>
                                <?php has_excerpt() ? the_excerpt() : ""; ?>
                                <address><?php echo getAuthorDetail($post->ID, 1, 1); ?></address>
                            </section>
                        </article>

                        <?php
                    // end of counter that is counting number of post


                    endwhile;
                }
                wp_reset_query();
                ?>

            </main>
        </section>

        <div class='more magazine'>
            <a class='button' href='<?php echo get_permalink(get_page_id_by_slug("magazine-archive")); ?>'>Back Issues</a>
        </div>
    </div>
    <!-- end landing stack -->
    <div class='rule'></div>


    <aside>
        <div class='aside-depts'>
            <!-- start aside trikedaily -->
            <?php show_latest_trike_daily(); ?>
            <!-- end aside trikedaily -->

            <!-- start aside ebooks -->
            <?php show_latest_ebooks(); ?>
            <!-- end aside ebooks -->

            <!-- start aside dharma talks -->
            <?php show_latest_dharma_talks(); ?>
            <!-- end aside dharma talks -->
        </div>
        <div class='rule'></div>
        <?php get_footer(); ?>